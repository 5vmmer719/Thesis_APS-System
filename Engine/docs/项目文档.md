# APS Engine 项目文档

## 项目概述

**APS Engine** 是一个基于 Rust 实现的汽车制造调度引擎，通过 gRPC 提供调度优化服务。

### 技术栈
- **语言**: Rust 2021
- **框架**: tonic (gRPC), tokio (异步运行时)
- **协议**: Protocol Buffers

## 核心功能

### 1. 调度算法
- **baseline**: EDD (Earliest Due Date) 基准算法
- **sa**: 模拟退火算法
- **hybrid**: 多起点模拟退火（性能最优）

### 2. 工艺流程
支持四大工艺串行调度：冲压 → 焊装 → 涂装 → 总装

### 3. 成本模型
```
总成本 = 延迟惩罚 + 颜色切换成本 + 配置切换成本 + 能耗超限 + 排放超限
```

## 数据模型

### 核心结构

```rust
// 输入
struct SolveInput {
    request_id: String,
    plan_start_epoch_ms: i64,  // 计划开始时间（毫秒时间戳）
    jobs: Vec<Job>,             // 作业列表
    params: SolveParams,        // 求解参数
}

struct Job {
    vin: String,                // 车辆识别码
    due_epoch_ms: i64,          // 交期（毫秒时间戳）
    stamping_minutes: i32,      // 冲压时长
    welding_minutes: i32,       // 焊装时长
    painting_minutes: i32,      // 涂装时长
    assemble_minutes: i32,      // 总装时长
    mold_code: String,          // 模具编号
    welding_fixture: String,    // 焊装夹具
    color: String,              // 颜色
    config: String,             // 配置
    energy_score: f64,          // 能耗分数
    emission_score: f64,        // 排放分数
}

struct SolveParams {
    algorithm: String,          // 算法: "baseline" | "sa" | "hybrid"
    time_budget_sec: i32,       // 时间预算（秒）
    seed: i32,                  // 随机种子
    weights: Weights,           // 成本权重
    limits: Limits,             // 约束限制
}

struct Weights {
    tardiness: f64,             // 延迟权重
    color_change: f64,          // 颜色切换权重
    config_change: f64,         // 配置切换权重
    energy_excess: f64,         // 能耗超限权重
    emission_excess: f64,       // 排放超限权重
    material_shortage: f64,     // 物料短缺权重
}

struct Limits {
    max_energy_per_shift: f64,  // 每班次最大能耗
    max_emission_per_shift: f64, // 每班次最大排放
}

// 输出
struct SolveOutput {
    request_id: String,
    summary: KpiSummary,              // 调度结果KPI
    baseline_summary: KpiSummary,     // 基准算法KPI
    order: Vec<String>,               // 调度顺序（VIN列表）
    schedule: Vec<ScheduleItem>,      // 简化调度（每车一条）
    detailed_schedule: Vec<ScheduleItem>, // 详细调度（每工序一条）
    violations: Vec<ShiftViolation>,  // 违规信息
    convergence: Vec<ConvergencePoint>, // 收敛曲线
}

struct KpiSummary {
    cost: f64,                  // 总成本
    total_tardiness_min: i32,   // 总延迟（分钟）
    max_tardiness_min: i32,     // 最大延迟（分钟）
    color_changes: i32,         // 颜色切换次数
    config_changes: i32,        // 配置切换次数
    energy_excess: f64,         // 能耗超限
    emission_excess: f64,       // 排放超限
    material_shortage: f64,     // 物料短缺
    elapsed_ms: i64,            // 执行时间（毫秒）
}

struct ScheduleItem {
    vin: String,
    process_type: i32,          // 1=冲压, 2=焊装, 3=涂装, 4=总装
    start_epoch_ms: i64,        // 开始时间
    end_epoch_ms: i64,          // 结束时间
    tardiness_min: i32,         // 延迟（分钟）
}
```

## gRPC 接口

### 服务定义

```protobuf
service ApsService {
    // 同步求解
    rpc Solve(SolveRequest) returns (SolveResponse);
    
    // 异步任务提交
    rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);
    
    // 查询任务状态
    rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse);
    
    // 列出所有任务
    rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);
}
```

### 1. Solve - 同步求解

**请求**: `SolveRequest`
```protobuf
message SolveRequest {
    string request_id = 1;
    int64 plan_start_epoch_ms = 2;
    repeated Job jobs = 3;
    SolveParams params = 4;
}
```

**响应**: `SolveResponse`
```protobuf
message SolveResponse {
    string request_id = 1;
    KpiSummary summary = 2;              // 调度结果
    KpiSummary baseline_summary = 3;     // 基准结果
    repeated string order = 4;           // 调度顺序
    repeated ScheduleItem schedule = 5;  // 简化调度
    repeated ScheduleItem detailed_schedule = 6; // 详细调度
    repeated ShiftViolation violations = 7;
    repeated ConvergencePoint convergence = 8;
}
```

### 2. SubmitJob - 异步提交

**请求**: `SubmitJobRequest`
```protobuf
message SubmitJobRequest {
    SolveRequest request = 1;
}
```

**响应**: `SubmitJobResponse`
```protobuf
message SubmitJobResponse {
    string job_id = 1;      // 任务ID
    string status = 2;      // 状态: "pending" | "running" | "completed" | "failed"
}
```

### 3. GetJobStatus - 查询状态

**请求**: `GetJobStatusRequest`
```protobuf
message GetJobStatusRequest {
    string job_id = 1;
}
```

**响应**: `GetJobStatusResponse`
```protobuf
message GetJobStatusResponse {
    string job_id = 1;
    string status = 2;
    SolveResponse result = 3;  // 完成时返回结果
    string error = 4;          // 失败时返回错误
}
```

### 4. ListJobs - 列出任务

**请求**: `ListJobsRequest`
```protobuf
message ListJobsRequest {
    int32 limit = 1;  // 最多返回数量
}
```

**响应**: `ListJobsResponse`
```protobuf
message ListJobsResponse {
    repeated JobInfo jobs = 1;
}

message JobInfo {
    string job_id = 1;
    string request_id = 2;
    string status = 3;
    int64 submit_time_ms = 4;
}
```

## 核心模块

### 1. src/model.rs
定义所有数据结构

### 2. src/eval.rs
评估函数：
- `build_schedule()`: 构建简化调度表
- `build_full_process_schedule()`: 构建详细工序调度表
- `build_kpi_summary()`: 计算KPI指标
- `build_violations()`: 检查约束违规

### 3. src/alg/
算法实现：
- `baseline.rs`: EDD算法
- `sa.rs`: 模拟退火算法
- `hybrid.rs`: 多起点模拟退火

### 4. src/service.rs
gRPC服务实现

### 5. src/async_job.rs
异步任务管理器

### 6. src/observability.rs
可观测性（指标、日志）

## 使用示例

### Rust 调用

```rust
use aps_engine::{solve, SolveInput, SolveParams, Job};

let input = SolveInput {
    request_id: "test-001".to_string(),
    plan_start_epoch_ms: 1704106800000,
    jobs: vec![/* ... */],
    params: SolveParams {
        algorithm: "sa".to_string(),
        time_budget_sec: 5,
        seed: 42,
        weights: Default::default(),
        limits: Default::default(),
    },
};

let output = solve(&input);
println!("成本: {}", output.summary.cost);
```

### gRPC 调用（Python示例）

```python
import grpc
import aps_pb2
import aps_pb2_grpc

channel = grpc.insecure_channel('localhost:50051')
stub = aps_pb2_grpc.ApsServiceStub(channel)

request = aps_pb2.SolveRequest(
    request_id="test-001",
    plan_start_epoch_ms=1704106800000,
    jobs=[...],
    params=aps_pb2.SolveParams(
        algorithm="sa",
        time_budget_sec=5,
        seed=42
    )
)

response = stub.Solve(request)
print(f"成本: {response.summary.cost}")
```

## 参数建议

### 算法选择
- 小规模 (≤20): `baseline` 或 `sa` (3s)
- 中等规模 (20-50): `sa` (5s)
- 大规模 (>50): `hybrid` (9-15s)

### 权重配置
```rust
// 默认权重
Weights {
    tardiness: 10.0,
    color_change: 50.0,
    config_change: 30.0,
    energy_excess: 2.0,
    emission_excess: 3.0,
    material_shortage: 0.0,
}
```

## 项目结构

```
.
├── src/
│   ├── lib.rs              # 库入口
│   ├── model.rs            # 数据模型
│   ├── eval.rs             # 评估函数
│   ├── service.rs          # gRPC服务
│   ├── async_job.rs        # 异步任务
│   ├── observability.rs    # 可观测性
│   ├── alg/
│   │   ├── mod.rs
│   │   ├── baseline.rs
│   │   ├── sa.rs
│   │   └── hybrid.rs
│   └── util/
├── proto/
│   └── aps.proto           # gRPC协议定义
├── tests/                  # 集成测试
├── examples/               # 示例代码
├── Cargo.toml
└── README.md
```

## 编译运行

```bash
# 编译
cargo build --release

# 运行服务
cargo run --release

# 运行测试
cargo test
```

服务默认监听 `0.0.0.0:50051`

