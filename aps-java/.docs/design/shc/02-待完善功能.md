# Schedule 模块待完善功能清单

> **版本**: v1.0 | **日期**: 2026-01-29 | **优先级**: 高→中→低

## 1. 工时数据获取 ⚠️ 高优先级

**位置**: `ScheduleEngineServiceImpl.convertToGrpcJob()`

**当前状态**: 使用硬编码默认值
```java
builder.setStampingMinutes(15);
builder.setWeldingMinutes(20);
builder.setPaintingMinutes(30);
builder.setAssembleMinutes(60);
```

**需要完善**:
- 根据 `order.modelId` 查询工艺路线 (Route)
- 从工艺路线关联的工序 (Operation) 获取实际工时
- 按工艺类型分类汇总

**影响**: 直接影响排产准确性

---

## 2. 订单属性映射 ⚠️ 高优先级

**位置**: `ScheduleEngineServiceImpl.convertToGrpcJob()`

**需要完善**:
- 确认 `ProductionOrderAttr.AttrKey` 常量定义
- 如果订单无属性，从车型获取默认值
- 增加属性缺失的容错处理

---

## 3. VIN到订单ID映射 ⚠️ 中优先级

**位置**: `ScheduleEngineServiceImpl.createBuckets()`

**当前状态**: 已注释
```java
// TODO: 关联订单ID（需要通过VIN查询）
// bucket.setProdOrderId(findOrderIdByVin(item.getVin()));
```

**实现建议**:
```java
private Long findOrderIdByVin(String vin) {
    LambdaQueryWrapper<ProductionOrder> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(ProductionOrder::getProdNo, vin);
    ProductionOrder order = productionOrderMapper.selectOne(wrapper);
    return order != null ? order.getId() : null;
}
```

---

## 4. 换型时间计算 ⚠️ 中优先级

**位置**: `ScheduleEngineServiceImpl.createBuckets()`

**当前状态**: 固定为0
```java
bucket.setSetupMinutes(0); // TODO: 计算换型时间
```

**实现建议**:
- 根据前后两辆车的颜色/配置变化判断
- 从规则快照或配置表获取换型时间

---

## 5. OTD准时率计算 ⚠️ 中优先级

**位置**: `ScheduleEngineServiceImpl.createStats()`

**当前状态**: 简化计算
```java
if (summary.getTotalTardinessMin() == 0) {
    stat.setOtdRate(BigDecimal.valueOf(100.0));
} else {
    stat.setOtdRate(BigDecimal.ZERO); // TODO
}
```

**实现建议**:
```java
// 准时率 = 准时订单数 / 总订单数
int totalJobs = response.getScheduleCount();
int onTimeJobs = (int) response.getScheduleList().stream()
    .filter(item -> item.getTardinessMin() == 0)
    .count();
stat.setOtdRate(BigDecimal.valueOf(onTimeJobs * 100.0 / totalJobs));
```

---

## 6. 产线负荷率计算 ⚠️ 中优先级

**位置**: `ScheduleEngineServiceImpl.createStats()`

**当前状态**: 固定为80
```java
stat.setAvgLineLoad(BigDecimal.valueOf(80.0)); // TODO
```

**实现建议**:
- 从 detailed_schedule 按产线统计工作时间
- 负荷率 = 实际生产时间 / 可用时间

---

## 7. 异步任务状态轮询 ⚠️ 低优先级

**位置**: `ScheduleTask.checkJobStatus()`

**当前状态**: 已注释
```java
// TODO: 调用引擎查询任务状态
// GetJobStatusResponse response = engineClient.getJobStatus(...);
```

**实现建议**: 取消注释并完善状态更新逻辑

---

## 8. 清理过期数据 ⚠️ 低优先级

**位置**: `ScheduleTask.cleanExpiredDraftPlans()`

**当前状态**: 空实现

**实现建议**:
```java
LocalDateTime expireTime = LocalDateTime.now().minusDays(30);
// 查询并删除过期草稿方案及关联数据
```

---

## 优先级说明

**高优先级**: 影响核心功能准确性，建议优先完成
**中优先级**: 影响数据完整性，可逐步完善
**低优先级**: 运维优化功能，可后续迭代

## 投产建议

✅ **可以投产**: 核心排产流程完整
⚠️ **建议**: 完成"工时数据获取"后再上线

