
APS 排产系统（四大工艺、辆/班）详细设计文档（增强版：流程图/时序/状态机/规则参数/甘特图交互）
说明：不展开接口与数据表。本文补齐“毕业设计/交付级”需要的流程与规则细节：
● 业务流程图（文字版）
● 关键时序（事件/调用顺序）
● 状态机（允许流转表）
● 排产规则参数说明（含示例配置）
● 甘特图/看板前端功能清单与交互规则
1. 业务流程图（文字版）
1.1 主数据准备流程（上线前/持续维护）
管理员登录
  -> 维护车型(车型编码/名称/启停)
  -> 维护物料(编码/类型/单位)
  -> 维护BOM(车型+版本+生效期) + 导入BOM明细(多层级/替代料/选装)
  -> 维护工艺路线(车型+工艺+版本) + 工序(顺序/工时/约束JSON)
  -> 维护资源(车间/产线/工位/设备/工装/人力组)
  -> 维护换型矩阵(工艺维度 from_key->to_key: minutes/cost)
  -> 维护约束规则(全局/工艺/产线/车型范围)
  -> 维护资源日历(按产线：天/班次容量=辆/班 + 维护窗口)
完成：进入“可排产条件满足”状态
1.2 订单到排产（计划侧）主流程
订单进入(销售订单导入或生产订单录入)
  -> 订单补全(选择车型/BOM版本/工艺版本/数量/交期/优先级/属性如颜色)
  -> 提交审批
  -> 管理员审批通过
  -> 订单进入“可排产池”
  -> 计划员创建排产任务(日期范围+四大工艺+产线范围+权重+规则开关)
  -> 排产引擎求解(异步)
  -> 返回方案(一个或多个) + KPI + 冲突/不可行原因
  -> 计划员查看甘特图/冲突面板/负荷面板
     -> (可选)手动调整(顺序/跨班次/跨产线)
     -> 重新校验并更新KPI
  -> 方案评审通过
  -> 发布方案(生成四大工艺工单)
结束：订单状态“已排产”，工单状态“待下达”
1.3 工单执行与闭环（执行侧）主流程
车间/班组长打开执行看板
  -> 筛选工艺/产线/日期/班次
  -> 对工单执行：
       下达 -> 开始 -> (暂停/恢复) -> 报工(多次) -> 完成
  -> 若发生异常：
       上报异常 -> 处理(接单/处理) -> 关闭
       (可选)建议触发重排/调整
  -> 同步质量数据/设备数据(可选自动采集)
结束：工单完成，订单完成，产量/KPI刷新
1.4 VIN追溯流程（质量/追责）
VIN生成(按订单批量生成或外部导入)
  -> VIN绑定(与总装工单或上线事件绑定)
  -> 生产过程记录事件(上线/工序开始/结束/质检结果/返工/下线)
  -> 关键件绑定(组件序列号/批次)
  -> 追溯查询(按VIN查全链路；按组件反查VIN)
2. 关键时序（文字版时序图）
2.1 排产任务时序（前端-后端-引擎）
[前端] 选择订单 + 日期范围 + 规则 -> 提交“创建排产任务”
  -> [后端] 校验订单状态=已审批、日历存在、路线版本存在
  -> [后端] 生成 job 记录(status=待运行)
  -> [前端] 调用“运行排产”
   -> [后端] job status=运行中，写入规则快照
   -> [后端] 组装排产输入(订单/属性/setup_key/日历容量/维护窗口/换型矩阵)
   -> [后端] gRPC 调用 Rust 引擎 Solve
   -> [引擎] 求解 -> 返回 plans[]/KPI/conflicts/infeasibleReasons
   -> [后端] 落库 plan/bucket/conflict/kpi -> job status=成功/不可行/失败
  -> [前端] 轮询“任务状态”直到完成
  -> [前端] 展示方案列表 + 甘特图 + 冲突面板
2.2 方案发布时序
[前端] 点击“发布方案”
  -> [后端] 校验 plan=草稿、冲突无致命(或管理员强制)
  -> [后端] 生成工单(按 bucket 转换为四大工艺工单)
  -> [后端] plan status=已发布；订单 status=已排产
  -> [后端] 写审计日志(发布人/时间/方案KPI)
  -> [前端] 刷新工单列表与订单状态
2.3 工单执行时序（报工）
[前端] 工单“开始”
  -> [后端] 校验状态(已下达->执行中) 写历史
[前端] 工单“报工”(良品/不良)
  -> [后端] 累计 qty_done，若超计划 -> 拒绝或记录超产策略
  -> [后端] 写报工记录/质检记录(如有)
  -> [前端] 实时刷新完成数、达成率
3. 状态机设计（允许流转表）
3.1 生产订单状态机（ord_prod.status）
状态值	名称	允许操作	下一状态	说明
0	新建	编辑、提交审批、取消	1/9	草稿阶段
1	待审批	审批通过、驳回、取消	2/0/9	驳回回到新建
2	已审批	创建排产任务、取消(受限)	3/9	可排产池
3	已排产	生成工单后自动进入	4	有工单待执行
4	执行中	由工单开始触发	5	任一工艺开工可置执行中
5	完成	自动/手动置完成	-	四大工艺均完成或总装完成
9	取消	-	-	终态
关键规则
● 已排产/执行中订单不允许直接取消；必须先作废方案/工单或走变更流程（管理员）。
● “完成”口径建议以总装工单完成为主（也可配置为四大工艺均完成）。
3.2 排产任务状态机（sch_job.status）
状态值	名称	触发	下一状态
0	待运行	创建任务	1
1	运行中	引擎求解中	2/3/4
2	成功	引擎输出可行方案	-
3	失败	系统/引擎异常	-
4	不可行	约束不可满足	-
不可行输出要求
● 必须返回 infeasibleReasons[] 或冲突列表（至少一条），供前端解释。
3.3 排产方案状态机（sch_plan.status）
状态值	名称	允许操作	下一状态
0	草稿	查看、调整、发布、作废	1/2
1	已发布	查看、导出、（可选）回滚	2(受限)
2	作废	查看	-
关键规则
● 已发布方案一般不允许调整；如需调整，应“复制为新方案/新版本”，保留可追溯链路。
3.4 工单状态机（exe_work_order.status）
状态值	名称	允许操作	下一状态
0	待下达	下达、作废	1/9
1	已下达	开始、作废(受限)	2/9
2	执行中	报工、暂停、完成	3/4
3	暂停	恢复、作废(受限)	2/9
4	完成	查看	-
9	作废	查看	-
完成判定
● 默认：qty_done >= qty_planned 可完成（允许超产策略需明确）。
● 若存在不良/返工逻辑，可扩展：完成=良品满足计划且返工闭环完成。
3.5 异常状态机（exe_exception.status）
状态值	名称	允许操作	下一状态
0	新建	接单、关闭(不建议)	1/2
1	处理中	更新处理过程、关闭	2
2	已关闭	查看	-
4. 排产规则参数说明（含示例配置）
规则分两类：
● 硬约束：不满足则不可行（返回 60001）
● 软约束：允许违反但会产生惩罚（影响目标函数/KPI，并形成冲突提示）
4.1 规则开关（constraints）
参数	类型	默认	约束类型	说明
enableMoldChange	boolean	true	软/硬可配	冲压模具切换时间/成本是否生效
enableColorSwitch	boolean	true	软/硬可配	涂装颜色切换模型是否生效
enableMaterialKitCheck	boolean	true	通常硬	总装齐套校验
respectMaintenanceWindow	boolean	true	硬	维护窗口内资源不可用
allowOverCapacity	boolean	false	软	是否允许超出班次产能（不建议）
interProcessBufferShifts	int	0	硬	工艺间缓冲班次数（0=不需要缓冲）
maxLateDays	int	0	软	允许最大延迟天数（>0表示可延迟但惩罚）
示例：
{
  "enableMoldChange": true,
  "enableColorSwitch": true,
  "enableMaterialKitCheck": true,
  "respectMaintenanceWindow": true,
  "allowOverCapacity": false,
  "interProcessBufferShifts": 1,
  "maxLateDays": 2
}
4.2 目标权重（objective）
参数	类型	建议范围	说明
dueDateWeight	number	0~1	越大越强调交期
setupWeight	number	0~1	越大越强调减少切换
utilizationWeight	number	0~1	越大越强调产线利用率
建议：三者归一化（和=1），或引擎内部自行归一化。
4.3 setup_key 设计（关键）
为让换型矩阵可用，订单需产生每工艺的 setup_key：
● 冲压：setup_key = mold_code（或 model+mold）
● 涂装：setup_key = color_code
● 焊装：可选（如夹具/车型平台）
● 总装：可选（如总成类型/关键配置）
规则：若某工艺未配置 setup_key，则该工艺不计算切换成本。
4.4 冲突分类（conflict_type）与前端提示
冲突类型	严重级别建议	说明	前端展示
CAPACITY	致命	班次容量不足（若不允许超产）	红色提示+定位班次
MAINTENANCE	致命	维护窗口冲突	红色提示
ROUTE	致命	找不到路线/资源不匹配	红色提示
MATERIAL	致命/警告	齐套不足	红/黄提示
SETUP	警告	切换过于频繁/成本过高	黄色提示
OTHER	提示	其他建议项	蓝色提示
5. 甘特图与排产中心（前端交互详细清单）
5.1 排产中心页面结构（建议）
● 左侧：筛选与操作
  ○ 任务列表（按日期/创建人/状态）
  ○ 方案列表（同一任务下多个方案）
● 中间：甘特图（按工艺分 Tab 或上下分区）
● 右侧：冲突面板 + KPI面板
● 顶部：操作区（运行、停止、复制方案、发布、导出）
5.2 甘特图展示要求（按班次桶）
行（row）维度
● 默认：按 工艺(process_type) + 产线(line) 分行
● 可选：展开到工位层（如果未来排到工位/设备）
块（item）显示信息
● label：订单号/车型/数量/班次
● tooltip：交期、优先级、颜色/模具key、切换成本、是否齐套等
● 颜色策略（建议）：
  ○ 按车型着色（便于混线识别）
  ○ 或涂装按颜色编码着色（最直观）
  ○ 冲突块高亮描边（红/黄）
5.3 甘特图交互（必须支持）
1. 缩放：日/班次维度缩放（横向）
2. 拖拽排序（同一班次内）：
  ○ 改变 seq_no
  ○ 自动触发：切换成本重新计算 + 冲突校验
3. 跨班次拖拽（同一产线）：
  ○ 改变 biz_date + shift_code
  ○ 校验：目标班次容量、维护窗口、工艺间缓冲
4. 跨产线拖拽（同一工艺内）：
  ○ 改变 line_id
  ○ 校验：产线是否在范围内、目标班次容量与维护窗口
5. 框选/多选操作（建议）：
  ○ 批量后移（+1班次/+1天）
  ○ 批量锁定（禁止引擎调整，增强项）
6. 冲突定位：
  ○ 点击冲突列表 → 甘特图自动滚动并高亮对应块/班次
5.4 手动调整后的反馈机制（前端要求）
调整提交后，后端应返回：
● 调整是否成功
● 方案 KPI（最新）
● 冲突列表（增量或全量）
● 若失败：返回失败原因（如容量不足、维护冲突）
前端应：
● 成功：更新甘特图块位置与 KPI
● 失败：回滚拖拽并弹出原因
6. 执行看板（前端功能清单）
6.1 工单列表（看板）
筛选条件：
● 工艺、产线、日期、班次、状态
展示字段：
● 工单号、订单号、车型、计划量、完成量、达成率、状态、顺序号
操作按钮（按状态显示）：
● 下达/开始/暂停/恢复/完工/作废（管理员）
6.2 工单详情
● 基本信息：来源方案、班次信息、关联订单
● 报工记录：时间、良品、不良、工位、备注
● 异常列表：类型、等级、状态、处理人
● VIN/质量（若启用）：VIN列表、关卡记录
7. VIN追溯页面（前端功能清单）
7.1 VIN查询页
● 输入 VIN（支持模糊）
● 展示 VIN 基本信息与当前状态
● 事件时间轴（按时间排序）
● 组件绑定列表（关键件）
7.2 反查（增强）
● 按组件序列号/批次号反查 VIN（若启用该功能）
8. 报表驾驶舱（指标口径说明）
8.1 计划达成率
● 日达成率 = 当日当工艺（或总装）工单完成量 / 计划量
● 支持：按工艺/产线/班次拆分
8.2 OTD（准时交付率）
● 订单层：在 due_date 当天或之前完成（以总装完成为准）则准时
● 统计周期：按完成日期落统计
8.3 负荷率
● 班次负荷率 = 班次分配量 / 班次容量（辆/班）
● 产线负荷率 = 区间内分配总量 / 区间内总容量
8.4 换型指标
● 换型次数：同一班次/产线相邻桶 setup_key 变化次数
● 换型时间：按矩阵求和（或引擎输出）
9. 关键边界场景与系统行为（必须明确）
9.1 排产不可行
系统必须输出“不可行原因”，如：
● 日历缺失/产能不足（硬约束）
● 维护窗口导致可用班次不足
● 齐套校验失败（关键物料缺口）
前端展示：弹窗 + 冲突列表 + 建议（减少范围/延长区间/关闭某规则）
9.2 插单进入
插单订单进入后建议提供两种策略（二选一实现）：
● 策略A：仅对“未发布区间”重排
● 策略B：允许影响已发布但未下达工单（需要管理员确认）
9.3 方案发布后调整
建议规则：
● 已发布方案不可直接调整
● 若必须调整：复制为新方案 → 再发布（保留审计）
9.4 工单超产
默认不允许超产（超出计划量报错）；如允许：
● 需记录超产原因
● KPI口径需说明（计划达成率可>100%？建议封顶）
info:
  title: APS Scheduling System API
  version: 1.0.0
  description: >
    汽车制造 APS 排产系统（四大工艺，按辆/班）REST API。
    BaseURL: /api/v1

servers:
  - url: /api/v1

tags:
  - name: Auth
  - name: Users
  - name: Dict
  - name: Config
  - name: MasterData-Model
  - name: MasterData-Item
  - name: MasterData-BOM
  - name: MasterData-Route
  - name: MasterData-Resource
  - name: Calendar
  - name: SalesOrder
  - name: ProdOrder
  - name: Approve
  - name: Plan-MPS
  - name: Plan-MRP
  - name: Schedule
  - name: WorkOrder
  - name: Exception
  - name: VIN-Trace
  - name: Reports
  - name: OpenAPI

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    accessKeyAuth:
      type: apiKey
      in: header
      name: X-Access-Key
    signatureAuth:
      type: apiKey
      in: header
      name: X-Signature
    timestampAuth:
      type: apiKey
      in: header
      name: X-Timestamp
    nonceAuth:
      type: apiKey
      in: header
      name: X-Nonce

  headers:
    XTraceId:
      description: Trace id for request tracking
      schema:
        type: string
    IdempotencyKey:
      description: Idempotency key for write operations
      schema:
        type: string

  parameters:
    PageNo:
      name: pageNo
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
    PageSize:
      name: pageSize
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 20
    Keyword:
      name: keyword
      in: query
      required: false
      schema:
        type: string
    Status:
      name: status
      in: query
      required: false
      schema:
        type: integer
    IdPath:
      name: id
      in: path
      required: true
      schema:
        type: integer
        format: int64
    FromDate:
      name: fromDate
      in: query
      required: true
      schema:
        type: string
        format: date
    ToDate:
      name: toDate
      in: query
      required: true
      schema:
        type: string
        format: date

  responses:
    ApiResponseOK:
      description: OK
      headers:
        X-Trace-Id:
          $ref: '#/components/headers/XTraceId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiResponse'
    ApiResponseError:
      description: Error
      headers:
        X-Trace-Id:
          $ref: '#/components/headers/XTraceId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiResponse'

  schemas:
    ApiResponse:
      type: object
      required: [code, message, data, timestamp]
      properties:
        code:
          type: integer
          description: 0=success, others=error
        message:
          type: string
        data:
          nullable: true
        traceId:
          type: string
        timestamp:
          type: integer
          format: int64

    PageResult:
      type: object
      required: [list, pageNo, pageSize, total]
      properties:
        list:
          type: array
          items: {}
        pageNo:
          type: integer
        pageSize:
          type: integer
        total:
          type: integer
          format: int64

    IdName:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string

    # ---------- Common DTO ----------
    UserDTO:
      type: object
      properties:
        id: { type: integer, format: int64 }
        username: { type: string }
        role: { type: string, enum: [admin, user] }
        realName: { type: string }
        mobile: { type: string }
        email: { type: string }
        status: { type: integer }
        lastLoginTime: { type: string, format: date-time }

    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string }
        password: { type: string }

    LoginResponse:
      type: object
      properties:
        token: { type: string }
        expiresIn: { type: integer }
        role: { type: string }
        userId: { type: integer, format: int64 }

    DictTypeDTO:
      type: object
      properties:
        id: { type: integer, format: int64 }
        typeCode: { type: string }
        typeName: { type: string }
        status: { type: integer }
        remark: { type: string }

    DictItemDTO:
      type: object
      properties:
        id: { type: integer, format: int64 }
        typeId: { type: integer, format: int64 }
        itemKey: { type: string }
        itemValue: { type: string }
        sortNo: { type: integer }
        status: { type: integer }
        remark: { type: string }

    # ---------- Master Data ----------
    ModelCreate:
      type: object
      required: [modelCode, modelName]
      properties:
        modelCode: { type: string }
        modelName: { type: string }
        platform: { type: string }
        status: { type: integer, default: 1 }
        remark: { type: string }

    ModelDTO:
      allOf:
        - $ref: '#/components/schemas/ModelCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    ItemCreate:
      type: object
      required: [itemCode, itemName, itemType]
      properties:
        itemCode: { type: string }
        itemName: { type: string }
        itemType: { type: integer, description: "1原料2半成品3成品4辅料" }
        uom: { type: string }
        spec: { type: string }
        status: { type: integer, default: 1 }
        remark: { type: string }

    ItemDTO:
      allOf:
        - $ref: '#/components/schemas/ItemCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    BomCreate:
      type: object
      required: [bomCode, modelId, version, effectiveFrom]
      properties:
        bomCode: { type: string }
        modelId: { type: integer, format: int64 }
        version: { type: string }
        effectiveFrom: { type: string, format: date-time }
        effectiveTo: { type: string, format: date-time, nullable: true }
        status: { type: integer, default: 1 }
        remark: { type: string }

    BomItemDTO:
      type: object
      properties:
        id: { type: integer, format: int64 }
        parentItemCode: { type: string, nullable: true }
        itemCode: { type: string }
        qty: { type: number, format: double }
        lossRate: { type: number, format: double }
        levelNo: { type: integer }
        isOptional: { type: integer, description: "0/1" }
        optionGroup: { type: string, nullable: true }
        altGroup: { type: string, nullable: true }
        remark: { type: string, nullable: true }

    BomDTO:
      allOf:
        - $ref: '#/components/schemas/BomCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }
            items:
              type: array
              items:
                $ref: '#/components/schemas/BomItemDTO'

    BomImportRequest:
      type: object
      required: [mode, items]
      properties:
        mode:
          type: string
          enum: [REPLACE, APPEND]
        items:
          type: array
          items:
            $ref: '#/components/schemas/BomItemDTO'

    RouteCreate:
      type: object
      required: [modelId, processType, version]
      properties:
        routeCode: { type: string, nullable: true }
        modelId: { type: integer, format: int64 }
        processType: { type: integer, description: "1冲压2焊装3涂装4总装" }
        version: { type: string }
        status: { type: integer, default: 1 }
        remark: { type: string }

    OperationCreate:
      type: object
      required: [opCode, opName, seqNo]
      properties:
        opCode: { type: string }
        opName: { type: string }
        seqNo: { type: integer }
        stdMinutesPerUnit: { type: integer, default: 0 }
        setupMinutes: { type: integer, default: 0 }
        stationGroup: { type: string, nullable: true }
        constraintJson: { type: object, nullable: true }
        status: { type: integer, default: 1 }
        remark: { type: string, nullable: true }

    OperationDTO:
      allOf:
        - $ref: '#/components/schemas/OperationCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    RouteDTO:
      allOf:
        - $ref: '#/components/schemas/RouteCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }
            operations:
              type: array
              items:
                $ref: '#/components/schemas/OperationDTO'

    # ---------- Resource DTO ----------
    WorkshopCreate:
      type: object
      required: [workshopCode, workshopName]
      properties:
        workshopCode: { type: string }
        workshopName: { type: string }
        processType: { type: integer, nullable: true }
        status: { type: integer, default: 1 }
        remark: { type: string }

    WorkshopDTO:
      allOf:
        - $ref: '#/components/schemas/WorkshopCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    LineCreate:
      type: object
      required: [workshopId, lineCode, lineName, processType]
      properties:
        workshopId: { type: integer, format: int64 }
        lineCode: { type: string }
        lineName: { type: string }
        processType: { type: integer }
        status: { type: integer, default: 1 }
        remark: { type: string }

    LineDTO:
      allOf:
        - $ref: '#/components/schemas/LineCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    StationCreate:
      type: object
      required: [lineId, stationCode, stationName]
      properties:
        lineId: { type: integer, format: int64 }
        stationCode: { type: string }
        stationName: { type: string }
        capacityQtyPerShift: { type: integer, default: 0 }
        status: { type: integer, default: 1 }
        remark: { type: string }

    StationDTO:
      allOf:
        - $ref: '#/components/schemas/StationCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    EquipmentCreate:
      type: object
      required: [stationId, equipCode, equipName]
      properties:
        stationId: { type: integer, format: int64 }
        equipCode: { type: string }
        equipName: { type: string }
        status: { type: integer, default: 1 }
        remark: { type: string }

    EquipmentDTO:
      allOf:
        - $ref: '#/components/schemas/EquipmentCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    ToolingCreate:
      type: object
      required: [toolingCode, toolingName, toolingType]
      properties:
        toolingCode: { type: string }
        toolingName: { type: string }
        toolingType: { type: integer, description: "1模具2夹具3检具" }
        status: { type: integer, default: 1 }
        remark: { type: string }

    ToolingDTO:
      allOf:
        - $ref: '#/components/schemas/ToolingCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    StationGroupCreate:
      type: object
      required: [groupCode, groupName]
      properties:
        groupCode: { type: string }
        groupName: { type: string }
        status: { type: integer, default: 1 }
        remark: { type: string }

    StationGroupDTO:
      allOf:
        - $ref: '#/components/schemas/StationGroupCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    LaborGroupCreate:
      type: object
      required: [laborCode, laborName]
      properties:
        laborCode: { type: string }
        laborName: { type: string }
        headcount: { type: integer, default: 0 }
        status: { type: integer, default: 1 }
        remark: { type: string }

    LaborGroupDTO:
      allOf:
        - $ref: '#/components/schemas/LaborGroupCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    # ---------- Calendar ----------
    CalendarDayBatchSetRequest:
      type: object
      required: [resourceType, resourceId, fromDate, toDate, isWorkday]
      properties:
        resourceType: { type: integer, description: "1产线2工位3设备4模具5人力组" }
        resourceId: { type: integer, format: int64 }
        fromDate: { type: string, format: date }
        toDate: { type: string, format: date }
        isWorkday: { type: integer, description: "0/1" }
        remark: { type: string, nullable: true }

    CalendarShiftSetRequest:
      type: object
      required: [resourceType, resourceId, bizDate, shifts]
      properties:
        resourceType: { type: integer }
        resourceId: { type: integer, format: int64 }
        bizDate: { type: string, format: date }
        shifts:
          type: array
          items:
            $ref: '#/components/schemas/ShiftDTO'

    ShiftDTO:
      type: object
      required: [shiftCode, startTime, endTime, capacityQty]
      properties:
        shiftCode: { type: string }
        startTime: { type: string, example: "08:00:00" }
        endTime: { type: string, example: "20:00:00" }
        capacityQty: { type: integer, description: "辆/班" }
        status: { type: integer, default: 1 }
        remark: { type: string, nullable: true }

    MaintenanceWindowCreate:
      type: object
      required: [resourceType, resourceId, startTime, endTime]
      properties:
        resourceType: { type: integer }
        resourceId: { type: integer, format: int64 }
        startTime: { type: string, format: date-time }
        endTime: { type: string, format: date-time }
        reason: { type: string, nullable: true }
        status: { type: integer, default: 1 }

    # ---------- Orders ----------
    SalesOrderCreate:
      type: object
      required: [salesNo, modelId, qty, dueDate]
      properties:
        salesNo: { type: string }
        customerCode: { type: string, nullable: true }
        modelId: { type: integer, format: int64 }
        qty: { type: integer }
        dueDate: { type: string, format: date }
        priority: { type: integer, default: 0 }
        status: { type: integer, default: 0 }
        remark: { type: string, nullable: true }
        sourcePayload: { type: object, nullable: true }

    SalesOrderDTO:
      allOf:
        - $ref: '#/components/schemas/SalesOrderCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }

    ProdOrderCreate:
      type: object
      required: [prodNo, orderKind, modelId, bomId, routeVersion, qty, dueDate]
      properties:
        prodNo: { type: string }
        salesId: { type: integer, format: int64, nullable: true }
        orderKind: { type: integer, description: "1常规2紧急3定制4插单5返工" }
        modelId: { type: integer, format: int64 }
        bomId: { type: integer, format: int64 }
        routeVersion: { type: string }
        qty: { type: integer }
        dueDate: { type: string, format: date }
        priority: { type: integer, default: 0 }
        status: { type: integer, default: 0 }
        remark: { type: string, nullable: true }

    ProdOrderDTO:
      allOf:
        - $ref: '#/components/schemas/ProdOrderCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }
            attrs:
              type: array
              items:
                $ref: '#/components/schemas/ProdOrderAttr'

    ProdOrderAttr:
      type: object
      required: [attrKey, attrValue]
      properties:
        attrKey: { type: string, example: "color" }
        attrValue: { type: string, example: "R001" }

    ProdOrderAttrsSetRequest:
      type: object
      required: [attrs]
      properties:
        attrs:
          type: array
          items:
            $ref: '#/components/schemas/ProdOrderAttr'

    ToProdRequest:
      type: object
      required: [orderKind, bomId, routeVersion]
      properties:
        orderKind: { type: integer }
        bomId: { type: integer, format: int64 }
        routeVersion: { type: string }

    CommentRequest:
      type: object
      properties:
        comment: { type: string }

    # ---------- Approve ----------
    ApproveTaskDTO:
      type: object
      properties:
        id: { type: integer, format: int64 }
        objectType: { type: string }
        objectId: { type: integer, format: int64 }
        stepNo: { type: integer }
        stepName: { type: string }
        assigneeRole: { type: string }
        status: { type: integer }
        comment: { type: string, nullable: true }

    # ---------- MPS/MRP ----------
    MpsCreate:
      type: object
      required: [mpsNo, startDate, endDate]
      properties:
        mpsNo: { type: string }
        startDate: { type: string, format: date }
        endDate: { type: string, format: date }
        status: { type: integer, default: 0 }
        remark: { type: string, nullable: true }

    MpsItem:
      type: object
      required: [bizDate, modelId, qty]
      properties:
        bizDate: { type: string, format: date }
        modelId: { type: integer, format: int64 }
        qty: { type: integer }

    MpsDTO:
      allOf:
        - $ref: '#/components/schemas/MpsCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }
            items:
              type: array
              items:
                $ref: '#/components/schemas/MpsItem'

    MrpRunRequest:
      type: object
      required: [mpsId]
      properties:
        mpsId: { type: integer, format: int64 }

    # ---------- Schedule ----------
    ScheduleJobCreate:
      type: object
      required: [horizonStart, horizonEnd, prodOrderIds, processTypes, objective, constraints]
      properties:
        horizonStart: { type: string, format: date }
        horizonEnd: { type: string, format: date }
        prodOrderIds:
          type: array
          items: { type: integer, format: int64 }
        processTypes:
          type: array
          items: { type: integer, description: "1~4" }
        lineScope:
          type: array
          items:
            $ref: '#/components/schemas/LineScope'
          nullable: true
        objective:
          $ref: '#/components/schemas/ScheduleObjective'
        constraints:
          $ref: '#/components/schemas/ScheduleConstraints'

    LineScope:
      type: object
      required: [processType, lineIds]
      properties:
        processType: { type: integer }
        lineIds:
          type: array
          items: { type: integer, format: int64 }

    ScheduleObjective:
      type: object
      required: [dueDateWeight, setupWeight, utilizationWeight]
      properties:
        dueDateWeight: { type: number, format: double }
        setupWeight: { type: number, format: double }
        utilizationWeight: { type: number, format: double }

    ScheduleConstraints:
      type: object
      required: [enableMoldChange, enableColorSwitch, enableMaterialKitCheck, respectMaintenanceWindow]
      properties:
        enableMoldChange: { type: boolean }
        enableColorSwitch: { type: boolean }
        enableMaterialKitCheck: { type: boolean }
        respectMaintenanceWindow: { type: boolean }

    ScheduleJobDTO:
      type: object
      properties:
        jobId: { type: integer, format: int64 }
        jobNo: { type: string }
        status: { type: integer }
        statusText: { type: string }
        plans:
          type: array
          items:
            $ref: '#/components/schemas/SchedulePlanBrief'
        errorMsg: { type: string, nullable: true }

    SchedulePlanBrief:
      type: object
      properties:
        planId: { type: integer, format: int64 }
        planNo: { type: string }
        isBest: { type: integer }
        kpi: { type: object, nullable: true }

    PublishPlanRequest:
      type: object
      properties:
        remark: { type: string, nullable: true }

    VoidPlanRequest:
      type: object
      properties:
        reason: { type: string }

    PlanAdjustRequest:
      type: object
      required: [changes]
      properties:
        changes:
          type: array
          items:
            $ref: '#/components/schemas/PlanAdjustChange'
        recheck:
          type: boolean
          default: true

    PlanAdjustChange:
      type: object
      required: [bucketId]
      properties:
        bucketId: { type: integer, format: int64 }
        toLineId: { type: integer, format: int64, nullable: true }
        toBizDate: { type: string, format: date, nullable: true }
        toShiftCode: { type: string, nullable: true }
        toSeqNo: { type: integer, nullable: true }

    # ---------- WorkOrder ----------
    WorkOrderDTO:
      type: object
      properties:
        id: { type: integer, format: int64 }
        woNo: { type: string }
        planId: { type: integer, format: int64 }
        planBucketId: { type: integer, format: int64 }
        processType: { type: integer }
        prodOrderId: { type: integer, format: int64 }
        lineId: { type: integer, format: int64 }
        bizDate: { type: string, format: date }
        shiftCode: { type: string }
        seqNo: { type: integer }
        qtyPlanned: { type: integer }
        qtyDone: { type: integer }
        status: { type: integer }
        remark: { type: string, nullable: true }

    WorkOrderActionRequest:
      type: object
      properties:
        remark: { type: string, nullable: true }

    WorkOrderReportRequest:
      type: object
      required: [reportTime, qtyGood, qtyBad]
      properties:
        reportTime: { type: string, format: date-time }
        stationId: { type: integer, format: int64, nullable: true }
        qtyGood: { type: integer }
        qtyBad: { type: integer }
        detailJson: { type: object, nullable: true }

    # ---------- Exception ----------
    ExceptionCreate:
      type: object
      required: [woId, type, level, desc]
      properties:
        woId: { type: integer, format: int64 }
        type: { type: string }
        level: { type: integer }
        desc: { type: string }
        payload: { type: object, nullable: true }

    ExceptionDTO:
      allOf:
        - $ref: '#/components/schemas/ExceptionCreate'
        - type: object
          properties:
            id: { type: integer, format: int64 }
            status: { type: integer }

    # ---------- VIN ----------
    VinBatchCreateRequest:
      type: object
      required: [prodOrderId, qty, ruleCode]
      properties:
        prodOrderId: { type: integer, format: int64 }
        qty: { type: integer }
        ruleCode: { type: string }

    VinDTO:
      type: object
      properties:
        vin: { type: string }
        modelId: { type: integer, format: int64 }
        prodOrderId: { type: integer, format: int64 }
        currentWoId: { type: integer, format: int64, nullable: true }
        status: { type: integer }

    VinComponentBindRequest:
      type: object
      required: [partCode, serialNo, bindTime]
      properties:
        partCode: { type: string }
        serialNo: { type: string }
        bindTime: { type: string, format: date-time }
        payload: { type: object, nullable: true }

    # ---------- Reports ----------
    KpiOverviewDTO:
      type: object
      properties:
        planQty: { type: integer }
        doneQty: { type: integer }
        otdRate: { type: number, format: double }
        setupTimes: { type: integer }
        avgLoadRate: { type: number, format: double }

paths:
  # ---------------- Auth ----------------
  /auth/login:
    post:
      tags: [Auth]
      security: []
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/LoginResponse'

  /auth/me:
    get:
      tags: [Auth]
      summary: Current user
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/UserDTO'

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout
      responses:
        '200':
          $ref: '#/components/responses/ApiResponseOK'

  # ---------------- Users ----------------
  /users:
    post:
      tags: [Users]
      summary: Create user (admin)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password, role]
              properties:
                username: { type: string }
                password: { type: string }
                role: { type: string, enum: [admin, user] }
                realName: { type: string }
                mobile: { type: string }
                email: { type: string }
                status: { type: integer, default: 1 }
      responses:
        '200':
          $ref: '#/components/responses/ApiResponseOK'
    get:
      tags: [Users]
      summary: List users
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: role
          in: query
          required: false
          schema: { type: string, enum: [admin, user] }
        - $ref: '#/components/parameters/Status'
        - $ref: '#/components/parameters/Keyword'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        allOf:
                          - $ref: '#/components/schemas/PageResult'
                          - type: object
                            properties:
                              list:
                                type: array
                                items:
                                  $ref: '#/components/schemas/UserDTO'

  /users/{id}:
    patch:
      tags: [Users]
      summary: Update user
      parameters:
        - $ref: '#/components/parameters/IdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role: { type: string, enum: [admin, user] }
                realName: { type: string }
                mobile: { type: string }
                email: { type: string }
                status: { type: integer }
      responses:
        '200':
          $ref: '#/components/responses/ApiResponseOK'

  /users/{id}/reset-password:
    post:
      tags: [Users]
      summary: Reset password
      parameters:
        - $ref: '#/components/parameters/IdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [newPassword]
              properties:
                newPassword: { type: string }
      responses:
        '200':
          $ref: '#/components/responses/ApiResponseOK'

  # ---------------- Dict/Config ----------------
  /dict/types:
    get:
      tags: [Dict]
      summary: Dict types
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/DictTypeDTO' }

  /dict/items:
    get:
      tags: [Dict]
      summary: Dict items by typeCode
      parameters:
        - name: typeCode
          in: query
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/DictItemDTO' }

  /config:
    get:
      tags: [Config]
      summary: List system config
      responses:
        '200':
          $ref: '#/components/responses/ApiResponseOK'

  /config/{id}:
    patch:
      tags: [Config]
      summary: Update config (admin)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                cfgValue: { type: string }
                status: { type: integer }
                remark: { type: string }
      responses:
        '200':
          $ref: '#/components/responses/ApiResponseOK'

  # ---------------- MasterData: Model ----------------
  /md/models:
    post:
      tags: [MasterData-Model]
      summary: Create model
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ModelCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Model]
      summary: List models
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - $ref: '#/components/parameters/Keyword'
        - $ref: '#/components/parameters/Status'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data:
                    allOf: [ { $ref: '#/components/schemas/PageResult' } ]
                    properties:
                      list:
                        type: array
                        items: { $ref: '#/components/schemas/ModelDTO' }

  /md/models/{id}:
    get:
      tags: [MasterData-Model]
      summary: Get model
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data: { $ref: '#/components/schemas/ModelDTO' }
    patch:
      tags: [MasterData-Model]
      summary: Update model
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                modelName: { type: string }
                platform: { type: string }
                status: { type: integer }
                remark: { type: string }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    delete:
      tags: [MasterData-Model]
      summary: Delete model (soft)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- MasterData: Item ----------------
  /md/items:
    post:
      tags: [MasterData-Item]
      summary: Create item
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ItemCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Item]
      summary: List items
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - $ref: '#/components/parameters/Keyword'
        - name: itemType
          in: query
          required: false
          schema: { type: integer }
        - $ref: '#/components/parameters/Status'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data:
                    allOf: [ { $ref: '#/components/schemas/PageResult' } ]
                    properties:
                      list:
                        type: array
                        items: { $ref: '#/components/schemas/ItemDTO' }

  /md/items/{id}:
    get:
      tags: [MasterData-Item]
      summary: Get item
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data: { $ref: '#/components/schemas/ItemDTO' }
    patch:
      tags: [MasterData-Item]
      summary: Update item
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                itemName: { type: string }
                itemType: { type: integer }
                uom: { type: string }
                spec: { type: string }
                status: { type: integer }
                remark: { type: string }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    delete:
      tags: [MasterData-Item]
      summary: Delete item (soft)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- MasterData: BOM ----------------
  /md/boms:
    post:
      tags: [MasterData-BOM]
      summary: Create BOM
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BomCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-BOM]
      summary: List BOMs
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: modelId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: version
          in: query
          required: false
          schema: { type: string }
        - $ref: '#/components/parameters/Status'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data:
                    allOf: [ { $ref: '#/components/schemas/PageResult' } ]
                    properties:
                      list:
                        type: array
                        items:
                          allOf:
                            - $ref: '#/components/schemas/BomCreate'
                            - type: object
                              properties:
                                id: { type: integer, format: int64 }

  /md/boms/{id}:
    get:
      tags: [MasterData-BOM]
      summary: Get BOM (with items)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data: { $ref: '#/components/schemas/BomDTO' }
    patch:
      tags: [MasterData-BOM]
      summary: Update BOM meta
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                effectiveFrom: { type: string, format: date-time }
                effectiveTo: { type: string, format: date-time, nullable: true }
                status: { type: integer }
                remark: { type: string }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/boms/{id}/items:import:
    post:
      tags: [MasterData-BOM]
      summary: Import BOM items (replace/append)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BomImportRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- MasterData: Route ----------------
  /md/routes:
    post:
      tags: [MasterData-Route]
      summary: Create route
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RouteCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Route]
      summary: List routes
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: modelId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: processType
          in: query
          required: false
          schema: { type: integer }
        - name: version
          in: query
          required: false
          schema: { type: string }
        - $ref: '#/components/parameters/Status'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/routes/{id}:
    get:
      tags: [MasterData-Route]
      summary: Get route (with operations)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data: { $ref: '#/components/schemas/RouteDTO' }
    patch:
      tags: [MasterData-Route]
      summary: Update route
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status: { type: integer }
                remark: { type: string }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/routes/{id}/operations:
    post:
      tags: [MasterData-Route]
      summary: Add operation to route
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/OperationCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/operations/{opId}:
    patch:
      tags: [MasterData-Route]
      summary: Update operation
      parameters:
        - name: opId
          in: path
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/OperationCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- MasterData: Resource ----------------
  /md/workshops:
    post:
      tags: [MasterData-Resource]
      summary: Create workshop
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkshopCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Resource]
      summary: List workshops
      parameters: [ { $ref: '#/components/parameters/PageNo' }, { $ref: '#/components/parameters/PageSize' }, { $ref: '#/components/parameters/Keyword' }, { $ref: '#/components/parameters/Status' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/lines:
    post:
      tags: [MasterData-Resource]
      summary: Create line
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LineCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Resource]
      summary: List lines
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: workshopId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: processType
          in: query
          required: false
          schema: { type: integer }
        - $ref: '#/components/parameters/Keyword'
        - $ref: '#/components/parameters/Status'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/stations:
    post:
      tags: [MasterData-Resource]
      summary: Create station
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/StationCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Resource]
      summary: List stations
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: lineId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - $ref: '#/components/parameters/Keyword'
        - $ref: '#/components/parameters/Status'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/equipments:
    post:
      tags: [MasterData-Resource]
      summary: Create equipment
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EquipmentCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Resource]
      summary: List equipments
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: stationId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - $ref: '#/components/parameters/Keyword'
        - $ref: '#/components/parameters/Status'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/toolings:
    post:
      tags: [MasterData-Resource]
      summary: Create tooling
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ToolingCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Resource]
      summary: List toolings
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: toolingType
          in: query
          required: false
          schema: { type: integer }
        - $ref: '#/components/parameters/Keyword'
        - $ref: '#/components/parameters/Status'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/station-groups:
    post:
      tags: [MasterData-Resource]
      summary: Create station group
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/StationGroupCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Resource]
      summary: List station groups
      parameters: [ { $ref: '#/components/parameters/PageNo' }, { $ref: '#/components/parameters/PageSize' }, { $ref: '#/components/parameters/Keyword' }, { $ref: '#/components/parameters/Status' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /md/labor-groups:
    post:
      tags: [MasterData-Resource]
      summary: Create labor group
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LaborGroupCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [MasterData-Resource]
      summary: List labor groups
      parameters: [ { $ref: '#/components/parameters/PageNo' }, { $ref: '#/components/parameters/PageSize' }, { $ref: '#/components/parameters/Keyword' }, { $ref: '#/components/parameters/Status' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Calendar ----------------
  /calendar/days:batch-set:
    post:
      tags: [Calendar]
      summary: Batch set calendar day
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CalendarDayBatchSetRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /calendar/days:
    get:
      tags: [Calendar]
      summary: Query calendar days
      parameters:
        - name: resourceType
          in: query
          required: true
          schema: { type: integer }
        - name: resourceId
          in: query
          required: true
          schema: { type: integer, format: int64 }
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /calendar/shifts:set:
    post:
      tags: [Calendar]
      summary: Set shifts for a day
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CalendarShiftSetRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /calendar/shifts:
    get:
      tags: [Calendar]
      summary: Query shifts
      parameters:
        - name: resourceType
          in: query
          required: true
          schema: { type: integer }
        - name: resourceId
          in: query
          required: true
          schema: { type: integer, format: int64 }
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /calendar/maintenance-windows:
    post:
      tags: [Calendar]
      summary: Create maintenance window
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MaintenanceWindowCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [Calendar]
      summary: Query maintenance windows
      parameters:
        - name: resourceType
          in: query
          required: true
          schema: { type: integer }
        - name: resourceId
          in: query
          required: true
          schema: { type: integer, format: int64 }
        - name: fromTime
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: toTime
          in: query
          required: false
          schema: { type: string, format: date-time }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /calendar/maintenance-windows/{id}:
    patch:
      tags: [Calendar]
      summary: Update maintenance window
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                startTime: { type: string, format: date-time }
                endTime: { type: string, format: date-time }
                reason: { type: string }
                status: { type: integer }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    delete:
      tags: [Calendar]
      summary: Delete maintenance window (soft)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Sales Orders ----------------
  /sales-orders:
    post:
      tags: [SalesOrder]
      summary: Create sales order
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SalesOrderCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [SalesOrder]
      summary: List sales orders
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: modelId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: status
          in: query
          required: false
          schema: { type: integer }
        - name: fromDueDate
          in: query
          required: false
          schema: { type: string, format: date }
        - name: toDueDate
          in: query
          required: false
          schema: { type: string, format: date }
        - $ref: '#/components/parameters/Keyword'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /sales-orders/{id}:
    get:
      tags: [SalesOrder]
      summary: Sales order detail
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /sales-orders/{id}/approve:
    post:
      tags: [SalesOrder]
      summary: Approve sales order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /sales-orders/{id}/to-prod:
    post:
      tags: [SalesOrder]
      summary: Convert sales order to prod order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ToProdRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Prod Orders ----------------
  /prod-orders:
    post:
      tags: [ProdOrder]
      summary: Create prod order
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProdOrderCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [ProdOrder]
      summary: List prod orders
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: status
          in: query
          required: false
          schema: { type: integer }
        - name: orderKind
          in: query
          required: false
          schema: { type: integer }
        - name: fromDueDate
          in: query
          required: false
          schema: { type: string, format: date }
        - name: toDueDate
          in: query
          required: false
          schema: { type: string, format: date }
        - $ref: '#/components/parameters/Keyword'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /prod-orders/{id}:
    get:
      tags: [ProdOrder]
      summary: Prod order detail (with attrs)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    patch:
      tags: [ProdOrder]
      summary: Update prod order (allowed in draft/pending)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                qty: { type: integer }
                dueDate: { type: string, format: date }
                priority: { type: integer }
                remark: { type: string }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /prod-orders/{id}/attrs:set:
    post:
      tags: [ProdOrder]
      summary: Set prod order attrs (color etc.)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProdOrderAttrsSetRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /prod-orders/{id}/submit-approve:
    post:
      tags: [ProdOrder]
      summary: Submit prod order for approval
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /prod-orders/{id}/approve:
    post:
      tags: [ProdOrder]
      summary: Approve prod order (admin)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /prod-orders/{id}/reject:
    post:
      tags: [ProdOrder]
      summary: Reject prod order (admin)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CommentRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /prod-orders/{id}/cancel:
    post:
      tags: [ProdOrder]
      summary: Cancel prod order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Approve ----------------
  /approve/tasks:
    get:
      tags: [Approve]
      summary: List approve tasks
      parameters:
        - name: status
          in: query
          required: false
          schema: { type: integer }
        - name: objectType
          in: query
          required: false
          schema: { type: string }
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /approve/tasks/{id}/pass:
    post:
      tags: [Approve]
      summary: Pass approve task
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /approve/tasks/{id}/reject:
    post:
      tags: [Approve]
      summary: Reject approve task
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CommentRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- MPS ----------------
  /plans/mps:
    post:
      tags: [Plan-MPS]
      summary: Create MPS
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MpsCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [Plan-MPS]
      summary: List MPS
      parameters: [ { $ref: '#/components/parameters/PageNo' }, { $ref: '#/components/parameters/PageSize' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /plans/mps/{id}:
    get:
      tags: [Plan-MPS]
      summary: Get MPS detail
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /plans/mps/{id}/submit-approve:
    post:
      tags: [Plan-MPS]
      summary: Submit MPS approve
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /plans/mps/{id}/approve:
    post:
      tags: [Plan-MPS]
      summary: Approve MPS (admin)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /plans/mps/{id}/close:
    post:
      tags: [Plan-MPS]
      summary: Close MPS
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- MRP ----------------
  /plans/mrp:run:
    post:
      tags: [Plan-MRP]
      summary: Run MRP by MPS
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MrpRunRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /plans/mrp:
    get:
      tags: [Plan-MRP]
      summary: List MRP results
      parameters:
        - name: mpsId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /plans/mrp/{id}:
    get:
      tags: [Plan-MRP]
      summary: MRP detail
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Schedule ----------------
  /schedules/jobs:
    post:
      tags: [Schedule]
      summary: Create schedule job
      parameters:
        - name: Idempotency-Key
          in: header
          required: false
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ScheduleJobCreate' }
      responses:
        '200':
          $ref: '#/components/responses/ApiResponseOK'

  /schedules/jobs/{jobId}/run:
    post:
      tags: [Schedule]
      summary: Run schedule job (async)
      parameters:
        - name: jobId
          in: path
          required: true
          schema: { type: integer, format: int64 }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /schedules/jobs/{jobId}:
    get:
      tags: [Schedule]
      summary: Get schedule job status
      parameters:
        - name: jobId
          in: path
          required: true
          schema: { type: integer, format: int64 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data: { $ref: '#/components/schemas/ScheduleJobDTO' }

  /schedules/plans:
    get:
      tags: [Schedule]
      summary: List plans by jobId
      parameters:
        - name: jobId
          in: query
          required: true
          schema: { type: integer, format: int64 }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /schedules/plans/{planId}:
    get:
      tags: [Schedule]
      summary: Plan detail (buckets)
      parameters:
        - name: planId
          in: path
          required: true
          schema: { type: integer, format: int64 }
        - name: processType
          in: query
          required: false
          schema: { type: integer }
        - name: fromDate
          in: query
          required: false
          schema: { type: string, format: date }
        - name: toDate
          in: query
          required: false
          schema: { type: string, format: date }
        - name: lineId
          in: query
          required: false
          schema: { type: integer, format: int64 }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /schedules/plans/{planId}/gantt:
    get:
      tags: [Schedule]
      summary: Gantt data for plan
      parameters:
        - name: planId
          in: path
          required: true
          schema: { type: integer, format: int64 }
        - name: processType
          in: query
          required: false
          schema: { type: integer }
        - name: fromDate
          in: query
          required: false
          schema: { type: string, format: date }
        - name: toDate
          in: query
          required: false
          schema: { type: string, format: date }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /schedules/plans/{planId}/conflicts:
    get:
      tags: [Schedule]
      summary: Plan conflicts
      parameters:
        - name: planId
          in: path
          required: true
          schema: { type: integer, format: int64 }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /schedules/plans/{planId}/adjust:
    post:
      tags: [Schedule]
      summary: Adjust plan buckets manually
      parameters:
        - name: planId
          in: path
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlanAdjustRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /schedules/plans/{planId}/publish:
    post:
      tags: [Schedule]
      summary: Publish plan to work orders
      parameters:
        - name: planId
          in: path
          required: true
          schema: { type: integer, format: int64 }
        - name: Idempotency-Key
          in: header
          required: false
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PublishPlanRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /schedules/plans/{planId}/void:
    post:
      tags: [Schedule]
      summary: Void plan (admin)
      parameters:
        - name: planId
          in: path
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VoidPlanRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- WorkOrder ----------------
  /work-orders:
    get:
      tags: [WorkOrder]
      summary: List work orders
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: processType
          in: query
          required: false
          schema: { type: integer }
        - name: lineId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: bizDate
          in: query
          required: false
          schema: { type: string, format: date }
        - name: shiftCode
          in: query
          required: false
          schema: { type: string }
        - name: status
          in: query
          required: false
          schema: { type: integer }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}:
    get:
      tags: [WorkOrder]
      summary: Work order detail
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}/release:
    post:
      tags: [WorkOrder]
      summary: Release work order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkOrderActionRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}/start:
    post:
      tags: [WorkOrder]
      summary: Start work order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkOrderActionRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}/pause:
    post:
      tags: [WorkOrder]
      summary: Pause work order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkOrderActionRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}/resume:
    post:
      tags: [WorkOrder]
      summary: Resume work order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkOrderActionRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}/complete:
    post:
      tags: [WorkOrder]
      summary: Complete work order
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkOrderActionRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}/void:
    post:
      tags: [WorkOrder]
      summary: Void work order (admin)
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason: { type: string }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /work-orders/{id}/report:
    post:
      tags: [WorkOrder]
      summary: Report work order production
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/WorkOrderReportRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Exception ----------------
  /exceptions:
    post:
      tags: [Exception]
      summary: Create exception
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ExceptionCreate' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }
    get:
      tags: [Exception]
      summary: List exceptions
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - name: status
          in: query
          required: false
          schema: { type: integer }
        - name: level
          in: query
          required: false
          schema: { type: integer }
        - name: type
          in: query
          required: false
          schema: { type: string }
        - name: fromTime
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: toTime
          in: query
          required: false
          schema: { type: string, format: date-time }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /exceptions/{id}:
    get:
      tags: [Exception]
      summary: Exception detail
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /exceptions/{id}/accept:
    post:
      tags: [Exception]
      summary: Accept exception
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /exceptions/{id}/close:
    post:
      tags: [Exception]
      summary: Close exception
      parameters: [ { $ref: '#/components/parameters/IdPath' } ]
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CommentRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- VIN & Trace ----------------
  /vins:batch-create:
    post:
      tags: [VIN-Trace]
      summary: Batch create VINs
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VinBatchCreateRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /vins:
    get:
      tags: [VIN-Trace]
      summary: List VINs
      parameters:
        - $ref: '#/components/parameters/PageNo'
        - $ref: '#/components/parameters/PageSize'
        - $ref: '#/components/parameters/Keyword'
        - name: status
          in: query
          required: false
          schema: { type: integer }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /vins/{vin}:
    get:
      tags: [VIN-Trace]
      summary: VIN detail
      parameters:
        - name: vin
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /vins/{vin}/events:
    get:
      tags: [VIN-Trace]
      summary: VIN trace events
      parameters:
        - name: vin
          in: path
          required: true
          schema: { type: string }
        - name: fromTime
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: toTime
          in: query
          required: false
          schema: { type: string, format: date-time }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /vins/{vin}/components:bind:
    post:
      tags: [VIN-Trace]
      summary: Bind component to VIN
      parameters:
        - name: vin
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VinComponentBindRequest' }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Reports ----------------
  /reports/kpi/overview:
    get:
      tags: [Reports]
      summary: KPI overview
      parameters:
        - name: fromDate
          in: query
          required: true
          schema: { type: string, format: date }
        - name: toDate
          in: query
          required: true
          schema: { type: string, format: date }
        - name: processType
          in: query
          required: false
          schema: { type: integer }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf: [ { $ref: '#/components/schemas/ApiResponse' } ]
                properties:
                  data: { $ref: '#/components/schemas/KpiOverviewDTO' }

  /reports/kpi/line-load:
    get:
      tags: [Reports]
      summary: Line load analysis
      parameters:
        - name: fromDate
          in: query
          required: true
          schema: { type: string, format: date }
        - name: toDate
          in: query
          required: true
          schema: { type: string, format: date }
        - name: processType
          in: query
          required: false
          schema: { type: integer }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /reports/kpi/setup:
    get:
      tags: [Reports]
      summary: Setup change analysis
      parameters:
        - name: planId
          in: query
          required: true
          schema: { type: integer, format: int64 }
        - name: processType
          in: query
          required: false
          schema: { type: integer }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /reports/bottleneck:
    get:
      tags: [Reports]
      summary: Bottleneck analysis
      parameters:
        - name: planId
          in: query
          required: true
          schema: { type: integer, format: int64 }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  # ---------------- Open API for external systems ----------------
  /open/erp/sales-orders:push:
    post:
      tags: [OpenAPI]
      summary: ERP push sales orders
      security:
        - accessKeyAuth: []
          signatureAuth: []
          timestampAuth: []
          nonceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [requestId, items]
              properties:
                requestId: { type: string }
                items:
                  type: array
                  items:
                    type: object
                    required: [salesNo, modelCode, qty, dueDate]
                    properties:
                      salesNo: { type: string }
                      modelCode: { type: string }
                      qty: { type: integer }
                      dueDate: { type: string, format: date }
                      priority: { type: integer, default: 0 }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /open/mes/work-orders:
    get:
      tags: [OpenAPI]
      summary: MES pull work orders
      security:
        - accessKeyAuth: []
          signatureAuth: []
          timestampAuth: []
          nonceAuth: []
      parameters:
        - name: bizDate
          in: query
          required: true
          schema: { type: string, format: date }
        - name: shiftCode
          in: query
          required: true
          schema: { type: string }
        - name: processType
          in: query
          required: true
          schema: { type: integer }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }

  /open/iot/equipments/status:push:
    post:
      tags: [OpenAPI]
      summary: IoT push equipment status
      security:
        - accessKeyAuth: []
          signatureAuth: []
          timestampAuth: []
          nonceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [requestId, items]
              properties:
                requestId: { type: string }
                items:
                  type: array
                  items:
                    type: object
                    required: [equipCode, healthStatus, eventTime]
                    properties:
                      equipCode: { type: string }
                      healthStatus: { type: integer, description: "0正常1预警2故障" }
                      eventTime: { type: string, format: date-time }
                      payload: { type: object, nullable: true }
      responses:
        '200': { $ref: '#/components/responses/ApiResponseOK' }APS 排产系统（四大工艺、辆/班）MySQL 建表语句（DDL，全量）
说明  
● MySQL 8.0+，InnoDB，utf8mb4  
● 主键 id BIGINT（雪花ID，应用生成）  
● 通用字段：created_time/created_by/updated_time/updated_by/deleted  
● 不强制外键（靠代码与索引保证一致性）  
● JSON 字段使用 JSON 类型  
● 如需我把字段注释再细化到业务口径/枚举值，请告诉我

1. 系统与权限（6张）
1.1 sys_user
CREATE TABLE IF NOT EXISTS sys_user (
  id BIGINT NOT NULL COMMENT 'PK 雪花ID',
  username VARCHAR(64) NOT NULL COMMENT '登录名',
  password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
  role VARCHAR(16) NOT NULL COMMENT '角色：admin/user',
  real_name VARCHAR(64) NULL COMMENT '姓名',
  mobile VARCHAR(32) NULL COMMENT '手机号',
  email VARCHAR(128) NULL COMMENT '邮箱',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '1启用0禁用',
  last_login_time DATETIME(3) NULL COMMENT '最近登录时间',
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0 COMMENT '0否1是',
  PRIMARY KEY (id),
  UNIQUE KEY uk_username (username),
  KEY idx_role (role),
  KEY idx_status (status),
  KEY idx_created_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
1.2 sys_audit_log
CREATE TABLE IF NOT EXISTS sys_audit_log (
  id BIGINT NOT NULL COMMENT 'PK',
  user_id BIGINT NULL COMMENT '操作人',
  action VARCHAR(64) NOT NULL COMMENT '动作',
  object_type VARCHAR(64) NOT NULL COMMENT '对象类型',
  object_id BIGINT NULL COMMENT '对象ID',
  request_id VARCHAR(64) NULL COMMENT 'traceId',
  detail JSON NULL COMMENT '详情',
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  PRIMARY KEY (id),
  KEY idx_obj (object_type, object_id),
  KEY idx_user_time (user_id, created_time),
  KEY idx_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审计日志';
1.3 sys_dict_type
CREATE TABLE IF NOT EXISTS sys_dict_type (
  id BIGINT NOT NULL,
  type_code VARCHAR(64) NOT NULL COMMENT '类型编码',
  type_name VARCHAR(128) NOT NULL COMMENT '类型名称',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '1启用0停用',
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_type_code (type_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典类型';
1.4 sys_dict_item
CREATE TABLE IF NOT EXISTS sys_dict_item (
  id BIGINT NOT NULL,
  type_id BIGINT NOT NULL COMMENT '字典类型ID',
  item_key VARCHAR(64) NOT NULL COMMENT '键',
  item_value VARCHAR(128) NOT NULL COMMENT '值',
  sort_no INT NOT NULL DEFAULT 0 COMMENT '排序',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '1启用0停用',
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_type_key (type_id, item_key),
  KEY idx_type_sort (type_id, sort_no),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='字典项';
1.5 sys_config
CREATE TABLE IF NOT EXISTS sys_config (
  id BIGINT NOT NULL,
  cfg_key VARCHAR(128) NOT NULL,
  cfg_value VARCHAR(2048) NOT NULL,
  cfg_group VARCHAR(64) NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_cfg_key (cfg_key),
  KEY idx_group (cfg_group),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统参数';
1.6 sys_api_client
CREATE TABLE IF NOT EXISTS sys_api_client (
  id BIGINT NOT NULL,
  client_code VARCHAR(64) NOT NULL,
  client_name VARCHAR(128) NOT NULL,
  access_key VARCHAR(128) NOT NULL,
  secret_key_hash VARCHAR(255) NOT NULL,
  ip_whitelist VARCHAR(1024) NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_client_code (client_code),
  UNIQUE KEY uk_access_key (access_key),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API调用方';

2. 主数据（8张）
2.1 md_model
CREATE TABLE IF NOT EXISTS md_model (
  id BIGINT NOT NULL,
  model_code VARCHAR(64) NOT NULL,
  model_name VARCHAR(128) NOT NULL,
  platform VARCHAR(64) NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_model_code (model_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='车型/产品';
2.2 md_item
CREATE TABLE IF NOT EXISTS md_item (
  id BIGINT NOT NULL,
  item_code VARCHAR(64) NOT NULL,
  item_name VARCHAR(255) NOT NULL,
  item_type TINYINT NOT NULL COMMENT '1原料2半成品3成品4辅料',
  uom VARCHAR(16) NULL,
  spec VARCHAR(255) NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_item_code (item_code),
  KEY idx_type (item_type),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='物料主数据';
2.3 md_bom
CREATE TABLE IF NOT EXISTS md_bom (
  id BIGINT NOT NULL,
  bom_code VARCHAR(64) NOT NULL,
  model_id BIGINT NOT NULL,
  version VARCHAR(32) NOT NULL,
  effective_from DATETIME(3) NOT NULL,
  effective_to DATETIME(3) NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_bom_code (bom_code),
  KEY idx_model_ver (model_id, version),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='BOM主表(多版本)';
2.4 md_bom_item
CREATE TABLE IF NOT EXISTS md_bom_item (
  id BIGINT NOT NULL,
  bom_id BIGINT NOT NULL,
  parent_item_code VARCHAR(64) NULL,
  item_code VARCHAR(64) NOT NULL,
  qty DECIMAL(18,6) NOT NULL,
  loss_rate DECIMAL(10,6) NOT NULL DEFAULT 0,
  level_no INT NOT NULL DEFAULT 1,
  is_optional TINYINT NOT NULL DEFAULT 0,
  option_group VARCHAR(64) NULL,
  alt_group VARCHAR(64) NULL,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_bom (bom_id),
  KEY idx_item (item_code),
  KEY idx_parent (parent_item_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='BOM明细(多层级)';
2.5 md_item_substitute
CREATE TABLE IF NOT EXISTS md_item_substitute (
  id BIGINT NOT NULL,
  alt_group VARCHAR(64) NOT NULL,
  item_code VARCHAR(64) NOT NULL,
  priority_no INT NOT NULL DEFAULT 1,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_group_priority (alt_group, priority_no),
  KEY idx_item (item_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='替代料关系';
2.6 md_item_stock
CREATE TABLE IF NOT EXISTS md_item_stock (
  id BIGINT NOT NULL,
  item_code VARCHAR(64) NOT NULL,
  warehouse_code VARCHAR(64) NOT NULL,
  biz_date DATE NOT NULL,
  qty_onhand DECIMAL(18,6) NOT NULL DEFAULT 0,
  qty_available DECIMAL(18,6) NOT NULL DEFAULT 0,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_item_wh_date (item_code, warehouse_code, biz_date),
  KEY idx_item (item_code),
  KEY idx_date (biz_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='库存快照(齐套校验可用)';
2.7 md_vin_rule
CREATE TABLE IF NOT EXISTS md_vin_rule (
  id BIGINT NOT NULL,
  rule_code VARCHAR(64) NOT NULL,
  model_id BIGINT NOT NULL,
  rule_json JSON NOT NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_rule_code (rule_code),
  KEY idx_model (model_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='VIN规则';
2.8 md_param_profile
CREATE TABLE IF NOT EXISTS md_param_profile (
  id BIGINT NOT NULL,
  profile_code VARCHAR(64) NOT NULL,
  profile_name VARCHAR(128) NOT NULL,
  param_json JSON NOT NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_profile_code (profile_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='参数配置集';

3. 工艺路线与约束（6张）
3.1 md_route
CREATE TABLE IF NOT EXISTS md_route (
  id BIGINT NOT NULL,
  route_code VARCHAR(64) NULL,
  model_id BIGINT NOT NULL,
  process_type TINYINT NOT NULL COMMENT '1冲压2焊装3涂装4总装',
  version VARCHAR(32) NOT NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_model_process_ver (model_id, process_type, version),
  UNIQUE KEY uk_route_code (route_code),
  KEY idx_model (model_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工艺路线(四大工艺，多版本)';
3.2 md_operation
CREATE TABLE IF NOT EXISTS md_operation (
  id BIGINT NOT NULL,
  route_id BIGINT NOT NULL,
  op_code VARCHAR(64) NOT NULL,
  op_name VARCHAR(128) NOT NULL,
  seq_no INT NOT NULL,
  std_minutes_per_unit INT NOT NULL DEFAULT 0 COMMENT '分钟/辆(估算)',
  setup_minutes INT NOT NULL DEFAULT 0 COMMENT '准备/换型分钟',
  station_group VARCHAR(64) NULL COMMENT '可选工位组',
  constraint_json JSON NULL COMMENT '工艺约束参数',
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_route_seq (route_id, seq_no),
  KEY idx_op_code (op_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工序定义';
3.3 md_op_resource_req
CREATE TABLE IF NOT EXISTS md_op_resource_req (
  id BIGINT NOT NULL,
  op_id BIGINT NOT NULL,
  resource_type TINYINT NOT NULL COMMENT '1产线2工位3设备4模具5人力组',
  resource_id BIGINT NOT NULL,
  qty INT NOT NULL DEFAULT 1,
  is_mandatory TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_op (op_id),
  KEY idx_res (resource_type, resource_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工序资源需求';
3.4 md_setup_matrix
CREATE TABLE IF NOT EXISTS md_setup_matrix (
  id BIGINT NOT NULL,
  process_type TINYINT NOT NULL COMMENT '1~4',
  from_key VARCHAR(64) NOT NULL,
  to_key VARCHAR(64) NOT NULL,
  setup_minutes INT NOT NULL DEFAULT 0,
  setup_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_process (process_type),
  KEY idx_from_to (process_type, from_key, to_key),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='换型/换模/换色矩阵';
3.5 md_constraint_rule
CREATE TABLE IF NOT EXISTS md_constraint_rule (
  id BIGINT NOT NULL,
  rule_code VARCHAR(64) NOT NULL,
  rule_name VARCHAR(128) NOT NULL,
  scope_type TINYINT NOT NULL DEFAULT 0 COMMENT '0全局1工艺2产线3车型',
  scope_id BIGINT NULL,
  rule_json JSON NOT NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_rule_code (rule_code),
  KEY idx_scope (scope_type, scope_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='约束规则配置';
3.6 md_quality_checkpoint
CREATE TABLE IF NOT EXISTS md_quality_checkpoint (
  id BIGINT NOT NULL,
  process_type TINYINT NOT NULL,
  op_code VARCHAR(64) NOT NULL,
  checkpoint_code VARCHAR(64) NOT NULL,
  checkpoint_name VARCHAR(128) NOT NULL,
  spec_json JSON NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_cp (checkpoint_code),
  KEY idx_process (process_type),
  KEY idx_op (op_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='质检关卡定义';

4. 组织与资源（10张）
4.1 md_workshop
CREATE TABLE IF NOT EXISTS md_workshop (
  id BIGINT NOT NULL,
  workshop_code VARCHAR(64) NOT NULL,
  workshop_name VARCHAR(128) NOT NULL,
  process_type TINYINT NULL COMMENT '可选：车间工艺',
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_workshop_code (workshop_code),
  KEY idx_process (process_type),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='车间';
4.2 md_line
CREATE TABLE IF NOT EXISTS md_line (
  id BIGINT NOT NULL,
  workshop_id BIGINT NOT NULL,
  line_code VARCHAR(64) NOT NULL,
  line_name VARCHAR(128) NOT NULL,
  process_type TINYINT NOT NULL COMMENT '1~4',
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_line_code (line_code),
  KEY idx_workshop (workshop_id),
  KEY idx_process (process_type),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='产线';
4.3 md_station
CREATE TABLE IF NOT EXISTS md_station (
  id BIGINT NOT NULL,
  line_id BIGINT NOT NULL,
  station_code VARCHAR(64) NOT NULL,
  station_name VARCHAR(128) NOT NULL,
  capacity_qty_per_shift INT NOT NULL DEFAULT 0 COMMENT '辆/班',
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_station_code (station_code),
  KEY idx_line (line_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工位';
4.4 md_station_group
CREATE TABLE IF NOT EXISTS md_station_group (
  id BIGINT NOT NULL,
  group_code VARCHAR(64) NOT NULL,
  group_name VARCHAR(128) NOT NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_group_code (group_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工位组';
4.5 md_station_group_rel
CREATE TABLE IF NOT EXISTS md_station_group_rel (
  id BIGINT NOT NULL,
  group_id BIGINT NOT NULL,
  station_id BIGINT NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_group_station (group_id, station_id),
  KEY idx_station (station_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工位组-工位关系';
4.6 md_equipment
CREATE TABLE IF NOT EXISTS md_equipment (
  id BIGINT NOT NULL,
  station_id BIGINT NOT NULL,
  equip_code VARCHAR(64) NOT NULL,
  equip_name VARCHAR(128) NOT NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_equip_code (equip_code),
  KEY idx_station (station_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备';
4.7 md_tooling
CREATE TABLE IF NOT EXISTS md_tooling (
  id BIGINT NOT NULL,
  tooling_code VARCHAR(64) NOT NULL,
  tooling_name VARCHAR(128) NOT NULL,
  tooling_type TINYINT NOT NULL COMMENT '1模具2夹具3检具',
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_tooling_code (tooling_code),
  KEY idx_type (tooling_type),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='模具/工装';
4.8 md_tooling_bind
CREATE TABLE IF NOT EXISTS md_tooling_bind (
  id BIGINT NOT NULL,
  tooling_id BIGINT NOT NULL,
  resource_type TINYINT NOT NULL COMMENT '2工位/3设备',
  resource_id BIGINT NOT NULL,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_tooling (tooling_id),
  KEY idx_resource (resource_type, resource_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工装可用关系';
4.9 md_labor_group
CREATE TABLE IF NOT EXISTS md_labor_group (
  id BIGINT NOT NULL,
  labor_code VARCHAR(64) NOT NULL,
  labor_name VARCHAR(128) NOT NULL,
  headcount INT NOT NULL DEFAULT 0,
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_labor_code (labor_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='人力组';
4.10 md_labor_group_rel
CREATE TABLE IF NOT EXISTS md_labor_group_rel (
  id BIGINT NOT NULL,
  labor_id BIGINT NOT NULL,
  station_id BIGINT NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_labor_station (labor_id, station_id),
  KEY idx_station (station_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='人力组-工位关系';

5. 资源日历（4张）
5.1 cal_day
CREATE TABLE IF NOT EXISTS cal_day (
  id BIGINT NOT NULL,
  resource_type TINYINT NOT NULL COMMENT '1产线2工位3设备4模具5人力组',
  resource_id BIGINT NOT NULL,
  biz_date DATE NOT NULL,
  is_workday TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_day (resource_type, resource_id, biz_date),
  KEY idx_date (biz_date),
  KEY idx_res (resource_type, resource_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资源日历(日)';
5.2 cal_shift
CREATE TABLE IF NOT EXISTS cal_shift (
  id BIGINT NOT NULL,
  day_id BIGINT NOT NULL,
  shift_code VARCHAR(32) NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  capacity_qty INT NOT NULL DEFAULT 0 COMMENT '辆/班容量',
  status TINYINT NOT NULL DEFAULT 1,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_day (day_id),
  KEY idx_shift (shift_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资源日历(班次)';
5.3 cal_maintenance_window
CREATE TABLE IF NOT EXISTS cal_maintenance_window (
  id BIGINT NOT NULL,
  resource_type TINYINT NOT NULL,
  resource_id BIGINT NOT NULL,
  start_time DATETIME(3) NOT NULL,
  end_time DATETIME(3) NOT NULL,
  reason VARCHAR(255) NULL,
  status TINYINT NOT NULL DEFAULT 1,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_res_time (resource_type, resource_id, start_time),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='维护窗口';
5.4 cal_holiday
CREATE TABLE IF NOT EXISTS cal_holiday (
  id BIGINT NOT NULL,
  biz_date DATE NOT NULL,
  name VARCHAR(64) NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_date (biz_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='节假日';

6. 订单与计划（8张）
6.1 ord_sales
CREATE TABLE IF NOT EXISTS ord_sales (
  id BIGINT NOT NULL,
  sales_no VARCHAR(64) NOT NULL,
  customer_code VARCHAR(64) NULL,
  model_id BIGINT NOT NULL,
  qty INT NOT NULL,
  due_date DATE NOT NULL,
  priority INT NOT NULL DEFAULT 0,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0新建1已审核2已转生产9取消',
  source_payload JSON NULL,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_sales_no (sales_no),
  KEY idx_due (due_date, priority),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='销售订单';
6.2 ord_prod
CREATE TABLE IF NOT EXISTS ord_prod (
  id BIGINT NOT NULL,
  prod_no VARCHAR(64) NOT NULL,
  sales_id BIGINT NULL,
  order_kind TINYINT NOT NULL COMMENT '1常规2紧急3定制4插单5返工',
  model_id BIGINT NOT NULL,
  bom_id BIGINT NOT NULL,
  route_version VARCHAR(32) NOT NULL,
  qty INT NOT NULL,
  due_date DATE NOT NULL,
  priority INT NOT NULL DEFAULT 0,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0新建1待审批2已审批3已排产4执行中5完成9取消',
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_prod_no (prod_no),
  KEY idx_sales (sales_id),
  KEY idx_due (due_date, priority),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='生产订单';
6.3 ord_prod_attr
CREATE TABLE IF NOT EXISTS ord_prod_attr (
  id BIGINT NOT NULL,
  ord_id BIGINT NOT NULL,
  attr_key VARCHAR(64) NOT NULL,
  attr_value VARCHAR(128) NOT NULL,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_order (ord_id),
  KEY idx_attr (attr_key, attr_value)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='生产订单属性(颜色等)';
6.4 flow_approve_task
CREATE TABLE IF NOT EXISTS flow_approve_task (
  id BIGINT NOT NULL,
  object_type VARCHAR(32) NOT NULL,
  object_id BIGINT NOT NULL,
  step_no INT NOT NULL,
  step_name VARCHAR(64) NOT NULL,
  assignee_role VARCHAR(16) NOT NULL COMMENT 'admin/user(简化)',
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0待处理1通过2驳回',
  comment VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_obj (object_type, object_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审批任务';
6.5 plan_mps
CREATE TABLE IF NOT EXISTS plan_mps (
  id BIGINT NOT NULL,
  mps_no VARCHAR(64) NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0草稿1审批中2已批准3关闭',
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_mps_no (mps_no),
  KEY idx_range (start_date, end_date),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='MPS主表';
6.6 plan_mps_item
CREATE TABLE IF NOT EXISTS plan_mps_item (
  id BIGINT NOT NULL,
  mps_id BIGINT NOT NULL,
  biz_date DATE NOT NULL,
  model_id BIGINT NOT NULL,
  qty INT NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_mps (mps_id, biz_date),
  KEY idx_model_date (model_id, biz_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='MPS明细';
6.7 plan_mrp
CREATE TABLE IF NOT EXISTS plan_mrp (
  id BIGINT NOT NULL,
  mrp_no VARCHAR(64) NOT NULL,
  mps_id BIGINT NOT NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0生成中1完成2失败',
  result_payload JSON NULL,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_mrp_no (mrp_no),
  KEY idx_mps (mps_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='MRP主表';
6.8 plan_mrp_item
CREATE TABLE IF NOT EXISTS plan_mrp_item (
  id BIGINT NOT NULL,
  mrp_id BIGINT NOT NULL,
  item_code VARCHAR(64) NOT NULL,
  req_date DATE NOT NULL,
  req_qty DECIMAL(18,6) NOT NULL DEFAULT 0,
  supply_qty DECIMAL(18,6) NOT NULL DEFAULT 0,
  shortage_qty DECIMAL(18,6) NOT NULL DEFAULT 0,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_mrp_item (mrp_id, item_code),
  KEY idx_date (req_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='MRP明细';

7. 排产（9张）
7.1 sch_job
CREATE TABLE IF NOT EXISTS sch_job (
  id BIGINT NOT NULL,
  job_no VARCHAR(64) NOT NULL,
  horizon_start DATE NOT NULL,
  horizon_end DATE NOT NULL,
  scope_json JSON NULL,
  objective_json JSON NULL,
  constraint_json JSON NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0待运行1运行中2成功3失败4不可行',
  engine_trace VARCHAR(128) NULL,
  error_msg VARCHAR(1024) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_job_no (job_no),
  KEY idx_status (status),
  KEY idx_created_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='排产任务';
7.2 sch_plan
CREATE TABLE IF NOT EXISTS sch_plan (
  id BIGINT NOT NULL,
  job_id BIGINT NOT NULL,
  plan_no VARCHAR(64) NOT NULL,
  is_best TINYINT NOT NULL DEFAULT 0,
  kpi_json JSON NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0草稿1已发布2作废',
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_job_best (job_id, is_best),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='排产方案';
7.3 sch_plan_bucket
CREATE TABLE IF NOT EXISTS sch_plan_bucket (
  id BIGINT NOT NULL,
  plan_id BIGINT NOT NULL,
  process_type TINYINT NOT NULL COMMENT '1~4',
  line_id BIGINT NOT NULL,
  biz_date DATE NOT NULL,
  shift_code VARCHAR(32) NOT NULL,
  prod_order_id BIGINT NOT NULL,
  seq_no INT NOT NULL,
  qty INT NOT NULL COMMENT '分配数量(辆)',
  from_setup_key VARCHAR(64) NULL,
  to_setup_key VARCHAR(64) NULL,
  setup_minutes INT NOT NULL DEFAULT 0,
  setup_cost DECIMAL(10,2) NOT NULL DEFAULT 0,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_plan_slot (plan_id, biz_date, shift_code, line_id),
  KEY idx_order (prod_order_id),
  KEY idx_process (process_type),
  KEY idx_line_date (line_id, biz_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='方案明细(班次桶)';
7.4 sch_plan_conflict
CREATE TABLE IF NOT EXISTS sch_plan_conflict (
  id BIGINT NOT NULL,
  plan_id BIGINT NOT NULL,
  conflict_type VARCHAR(64) NOT NULL,
  level TINYINT NOT NULL COMMENT '1提示2警告3致命',
  object_type VARCHAR(32) NULL,
  object_id BIGINT NULL,
  message VARCHAR(1024) NOT NULL,
  payload JSON NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_plan_level (plan_id, level),
  KEY idx_type (conflict_type),
  KEY idx_obj (object_type, object_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='方案冲突/不可行原因';
7.5 sch_rule_snapshot
CREATE TABLE IF NOT EXISTS sch_rule_snapshot (
  id BIGINT NOT NULL,
  job_id BIGINT NOT NULL,
  rule_json JSON NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_job (job_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='排产规则快照';
7.6 sch_engine_result_raw
CREATE TABLE IF NOT EXISTS sch_engine_result_raw (
  id BIGINT NOT NULL,
  job_id BIGINT NOT NULL,
  raw_json JSON NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_job (job_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='引擎原始返回(调试)';
7.7 sch_wip_link
CREATE TABLE IF NOT EXISTS sch_wip_link (
  id BIGINT NOT NULL,
  prod_order_id BIGINT NOT NULL,
  process_type TINYINT NOT NULL,
  plan_bucket_id BIGINT NULL,
  wo_id BIGINT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_order_process (prod_order_id, process_type),
  KEY idx_bucket (plan_bucket_id),
  KEY idx_wo (wo_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='四大工艺串联绑定';
7.8 sch_plan_stat
CREATE TABLE IF NOT EXISTS sch_plan_stat (
  id BIGINT NOT NULL,
  plan_id BIGINT NOT NULL,
  otd_rate DECIMAL(10,4) NOT NULL DEFAULT 0,
  setup_times INT NOT NULL DEFAULT 0,
  avg_line_load DECIMAL(10,4) NOT NULL DEFAULT 0,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_plan (plan_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='方案统计';
7.9 sch_manual_adjust_log
CREATE TABLE IF NOT EXISTS sch_manual_adjust_log (
  id BIGINT NOT NULL,
  plan_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  change_json JSON NOT NULL,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_plan_time (plan_id, created_time),
  KEY idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='手动调整日志';

8. 执行（7张）
8.1 exe_work_order
CREATE TABLE IF NOT EXISTS exe_work_order (
  id BIGINT NOT NULL,
  wo_no VARCHAR(64) NOT NULL,
  plan_id BIGINT NOT NULL,
  plan_bucket_id BIGINT NOT NULL,
  process_type TINYINT NOT NULL,
  prod_order_id BIGINT NOT NULL,
  line_id BIGINT NOT NULL,
  biz_date DATE NOT NULL,
  shift_code VARCHAR(32) NOT NULL,
  seq_no INT NOT NULL,
  qty_planned INT NOT NULL,
  qty_done INT NOT NULL DEFAULT 0,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0待下达1已下达2执行中3暂停4完成9作废',
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_wo_no (wo_no),
  KEY idx_plan (plan_id),
  KEY idx_bucket (plan_bucket_id),
  KEY idx_order (prod_order_id),
  KEY idx_line_slot (line_id, biz_date, shift_code),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工单';
8.2 exe_work_order_op
CREATE TABLE IF NOT EXISTS exe_work_order_op (
  id BIGINT NOT NULL,
  wo_id BIGINT NOT NULL,
  op_code VARCHAR(64) NOT NULL,
  seq_no INT NOT NULL,
  station_id BIGINT NULL,
  qty_done INT NOT NULL DEFAULT 0,
  status TINYINT NOT NULL DEFAULT 0,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_wo (wo_id, seq_no),
  KEY idx_op (op_code),
  KEY idx_station (station_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工单工序执行(可选)';
8.3 exe_report
CREATE TABLE IF NOT EXISTS exe_report (
  id BIGINT NOT NULL,
  wo_id BIGINT NOT NULL,
  report_time DATETIME(3) NOT NULL,
  station_id BIGINT NULL,
  qty_good INT NOT NULL DEFAULT 0,
  qty_bad INT NOT NULL DEFAULT 0,
  detail_json JSON NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_wo_time (wo_id, report_time),
  KEY idx_station_time (station_id, report_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='报工记录';
8.4 exe_exception
CREATE TABLE IF NOT EXISTS exe_exception (
  id BIGINT NOT NULL,
  wo_id BIGINT NOT NULL,
  type VARCHAR(64) NOT NULL,
  level TINYINT NOT NULL DEFAULT 1,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0新建1处理中2关闭',
  `desc` VARCHAR(1024) NOT NULL,
  payload JSON NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_wo_status (wo_id, status),
  KEY idx_type (type),
  KEY idx_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='执行异常';
8.5 exe_quality_record
CREATE TABLE IF NOT EXISTS exe_quality_record (
  id BIGINT NOT NULL,
  wo_id BIGINT NOT NULL,
  vin VARCHAR(32) NULL,
  checkpoint_code VARCHAR(64) NOT NULL,
  check_time DATETIME(3) NOT NULL,
  result TINYINT NOT NULL COMMENT '1合格0不合格',
  detail_json JSON NULL,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_wo (wo_id),
  KEY idx_vin_time (vin, check_time),
  KEY idx_cp (checkpoint_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='质检记录';
8.6 exe_device_data
CREATE TABLE IF NOT EXISTS exe_device_data (
  id BIGINT NOT NULL,
  equip_id BIGINT NOT NULL,
  collect_time DATETIME(3) NOT NULL,
  data_json JSON NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_equip_time (equip_id, collect_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备采集数据(可选)';
8.7 exe_status_history
CREATE TABLE IF NOT EXISTS exe_status_history (
  id BIGINT NOT NULL,
  wo_id BIGINT NOT NULL,
  from_status TINYINT NOT NULL,
  to_status TINYINT NOT NULL,
  operator_id BIGINT NOT NULL,
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_wo_time (wo_id, created_time),
  KEY idx_op_time (operator_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工单状态历史';

9. VIN与追溯（3张）
9.1 trace_vin
CREATE TABLE IF NOT EXISTS trace_vin (
  id BIGINT NOT NULL,
  vin VARCHAR(32) NOT NULL,
  model_id BIGINT NOT NULL,
  prod_order_id BIGINT NOT NULL,
  current_wo_id BIGINT NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0创建1上线2完工',
  remark VARCHAR(255) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_vin (vin),
  KEY idx_order (prod_order_id),
  KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='VIN主表';
9.2 trace_event
CREATE TABLE IF NOT EXISTS trace_event (
  id BIGINT NOT NULL,
  vin VARCHAR(32) NOT NULL,
  process_type TINYINT NOT NULL,
  event_type VARCHAR(64) NOT NULL,
  event_time DATETIME(3) NOT NULL,
  station_id BIGINT NULL,
  payload JSON NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_vin_time (vin, event_time),
  KEY idx_type (event_type),
  KEY idx_station_time (station_id, event_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='VIN追溯事件';
9.3 trace_component_bind
CREATE TABLE IF NOT EXISTS trace_component_bind (
  id BIGINT NOT NULL,
  vin VARCHAR(32) NOT NULL,
  part_code VARCHAR(64) NOT NULL,
  serial_no VARCHAR(128) NOT NULL,
  bind_time DATETIME(3) NOT NULL,
  payload JSON NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_vin (vin),
  KEY idx_part (part_code, serial_no),
  KEY idx_time (bind_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='VIN-组件绑定追溯';

10. 对接与消息（4张）
10.1 intf_inbound_log
CREATE TABLE IF NOT EXISTS intf_inbound_log (
  id BIGINT NOT NULL,
  source_system VARCHAR(32) NOT NULL,
  api_name VARCHAR(128) NOT NULL,
  request_id VARCHAR(64) NULL,
  payload JSON NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0成功1失败',
  error_msg VARCHAR(1024) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_sys_time (source_system, created_time),
  KEY idx_api_time (api_name, created_time),
  KEY idx_request (request_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='外部入站日志';
10.2 intf_outbound_log
CREATE TABLE IF NOT EXISTS intf_outbound_log (
  id BIGINT NOT NULL,
  target_system VARCHAR(32) NOT NULL,
  api_name VARCHAR(128) NOT NULL,
  request_id VARCHAR(64) NULL,
  payload JSON NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0成功1失败',
  error_msg VARCHAR(1024) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_sys_time (target_system, created_time),
  KEY idx_api_time (api_name, created_time),
  KEY idx_request (request_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='外部出站日志';
10.3 mq_event_outbox
CREATE TABLE IF NOT EXISTS mq_event_outbox (
  id BIGINT NOT NULL,
  event_type VARCHAR(64) NOT NULL,
  routing_key VARCHAR(128) NOT NULL,
  payload JSON NOT NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0待发送1已发送2失败',
  retry_count INT NOT NULL DEFAULT 0,
  next_retry_time DATETIME(3) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_status_time (status, created_time),
  KEY idx_next_retry (next_retry_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Outbox事件表';
10.4 mq_event_consume
CREATE TABLE IF NOT EXISTS mq_event_consume (
  id BIGINT NOT NULL,
  event_id VARCHAR(64) NOT NULL,
  consumer VARCHAR(64) NOT NULL,
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0成功1失败',
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_event_id (event_id),
  KEY idx_consumer_time (consumer, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='MQ消费幂等';

11. 报表与快照（4张，可选）
11.1 rpt_kpi_daily
CREATE TABLE IF NOT EXISTS rpt_kpi_daily (
  id BIGINT NOT NULL,
  biz_date DATE NOT NULL,
  process_type TINYINT NOT NULL,
  line_id BIGINT NOT NULL,
  plan_qty INT NOT NULL DEFAULT 0,
  done_qty INT NOT NULL DEFAULT 0,
  otd_rate DECIMAL(10,4) NOT NULL DEFAULT 0,
  setup_times INT NOT NULL DEFAULT 0,
  load_rate DECIMAL(10,4) NOT NULL DEFAULT 0,
  payload JSON NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_day (biz_date, process_type, line_id),
  KEY idx_date (biz_date),
  KEY idx_line (line_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='日KPI快照';
11.2 rpt_bottleneck
CREATE TABLE IF NOT EXISTS rpt_bottleneck (
  id BIGINT NOT NULL,
  plan_id BIGINT NOT NULL,
  bottleneck_type VARCHAR(64) NOT NULL,
  bottleneck_id BIGINT NOT NULL,
  score DECIMAL(10,4) NOT NULL DEFAULT 0,
  suggestion VARCHAR(1024) NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_plan (plan_id),
  KEY idx_type_score (bottleneck_type, score)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='瓶颈分析结果';
11.3 snap_plan_publish
CREATE TABLE IF NOT EXISTS snap_plan_publish (
  id BIGINT NOT NULL,
  plan_id BIGINT NOT NULL,
  snapshot_json JSON NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  KEY idx_plan (plan_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='发布快照';
11.4 snap_masterdata_version
CREATE TABLE IF NOT EXISTS snap_masterdata_version (
  id BIGINT NOT NULL,
  snapshot_code VARCHAR(64) NOT NULL,
  snapshot_json JSON NOT NULL,
  created_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  created_by BIGINT NULL,
  updated_time DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  updated_by BIGINT NULL,
  deleted TINYINT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_snapshot_code (snapshot_code),
  KEY idx_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='主数据版本快照';