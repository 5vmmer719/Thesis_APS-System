# APS 排产系统（前端对接接口规范 /api/v1）

范围：仅覆盖 Web 前端需要的接口（登录/字典/主数据/日历/订单审批/排产甘特图/工单执行/异常/VIN/报表），不包含对外 OpenAPI（ERP/MES/IoT）。

## 0. 通用约定

- BaseURL：`/api/v1`
- Header：

- `Authorization: Bearer <JWT>`
- `Content-Type: application/json`
- 可选：`X-Trace-Id`
- 对“触发排产/发布方案”等可选：`Idempotency-Key`

- 时间：

- `date`：`YYYY-MM-DD`
- `datetime`：ISO8601（如 `2026-01-22T10:12:00+08:00`）

- 分页：`pageNo`(默认1)、`pageSize`(默认20)
- 统一响应：

```
{ "code": 0, "message": "ok", "data": {}, "traceId": "xxx", "timestamp": 1760000000000 }
```

### 错误码（前端需处理）

- `40101`：未登录/过期 → 跳转登录
- `40301`：无权限 → 提示
- `40001`：参数错误 → 表单提示
- `40002`：状态不允许（审批/发布/流转）→ 提示原因
- `60001`：排产不可行 → 展示不可行原因/冲突列表
- `60002`：排产引擎不可用/超时 → 提示稍后重试

---

## 1. 认证与用户

### 1.1 登录

**POST** `/auth/login`

```
{ "username": "admin", "password": "123456" }
```

返回 `data`：

```
{ "token": "jwt...", "expiresIn": 7200, "role": "admin", "userId": 1 }
```

### 1.2 当前用户

**GET** `/auth/me`  
返回 `data`：

```
{ "userId": 1, "username": "admin", "role": "admin", "realName": "管理员" }
```

### 1.3 退出登录（可选）

**POST** `/auth/logout`

---

## 2. 字典（用于渲染枚举下拉）

### 2.1 字典类型

**GET** `/dict/types`

### 2.2 字典项

**GET** `/dict/items?typeCode=PROD_ORDER_STATUS`

常用 typeCode：

- `PROCESS_TYPE`、`ORDER_KIND`、`PROD_ORDER_STATUS`、`SALES_ORDER_STATUS`
- `SCHEDULE_JOB_STATUS`、`SCHEDULE_PLAN_STATUS`、`WORK_ORDER_STATUS`
- `EXCEPTION_TYPE`、`EXCEPTION_LEVEL`、`EXCEPTION_STATUS`

---

## 3. 主数据（前端维护页面）

模块共性：

- 列表：`GET` 支持 `pageNo/pageSize/keyword/status`
- 新增：`POST`
- 详情：`GET /{id}`
- 修改：`PATCH /{id}`
- 删除：`DELETE /{id}`（软删）

### 3.1 车型

- **POST** `/md/models`
- **GET** `/md/models`
- **GET** `/md/models/{id}`
- **PATCH** `/md/models/{id}`
- **DELETE** `/md/models/{id}`

### 3.2 物料

- **POST** `/md/items`
- **GET** `/md/items?itemType=1&keyword=xxx`
- **GET** `/md/items/{id}`
- **PATCH** `/md/items/{id}`
- **DELETE** `/md/items/{id}`

### 3.3 BOM（多版本 + 明细导入）

- **POST** `/md/boms`
- **GET** `/md/boms?modelId=11&version=V1`
- **GET** `/md/boms/{id}`（含 items）
- **PATCH** `/md/boms/{id}`（启停/生效期）
- **POST** `/md/boms/{id}/items:import`（覆盖/追加）

`items:import` 请求：

```
{
  "mode": "REPLACE",
  "items": [
    { "parentItemCode": "FG-A7L", "itemCode": "P001", "qty": 1, "lossRate": 0, "levelNo": 1, "isOptional": 0 }
  ]
}
```

### 3.4 工艺路线/工序

- **POST** `/md/routes`
- **GET** `/md/routes?modelId=11&processType=4&version=V1`
- **GET** `/md/routes/{id}`（含 operations）
- **PATCH** `/md/routes/{id}`
- **POST** `/md/routes/{id}/operations`
- **PATCH** `/md/operations/{opId}`

工序 `constraintJson` 为 JSON，用于颜色/模具/齐套等规则。

### 3.5 资源（车间/产线/工位/设备/工装/工位组/人力组）

- 车间：`/md/workshops`
- 产线：`/md/lines`
- 工位：`/md/stations`
- 设备：`/md/equipments`
- 工装：`/md/toolings`
- 工位组：`/md/station-groups`
- 人力组：`/md/labor-groups`

前端若要维护“关系”（工位组-工位、人力组-工位、工装绑定），建议补充这些接口（推荐前端使用）：

#### 3.5.1 工位组-工位关系

- **POST** `/md/station-groups/{id}/stations:bind`

```
{ "stationIds": [5101, 5102] }
```

- **POST** `/md/station-groups/{id}/stations:unbind`

```
{ "stationIds": [5102] }
```

- **GET** `/md/station-groups/{id}/stations`

#### 3.5.2 人力组-工位关系

- **POST** `/md/labor-groups/{id}/stations:bind`
- **POST** `/md/labor-groups/{id}/stations:unbind`
- **GET** `/md/labor-groups/{id}/stations`

#### 3.5.3 工装绑定（模具-设备/工位）

- **POST** `/md/toolings/{id}/binds:bind`

```
{ "binds": [ { "resourceType": 2, "resourceId": 5101 }, { "resourceType": 3, "resourceId": 6101 } ] }
```

- **POST** `/md/toolings/{id}/binds:unbind`
- **GET** `/md/toolings/{id}/binds`

### 3.6 换型矩阵 / 约束规则

- 换型矩阵：

- **POST** `/md/setup-matrix`
- **GET** `/md/setup-matrix?processType=3&fromKey=R001`
- **PATCH** `/md/setup-matrix/{id}`
- **DELETE** `/md/setup-matrix/{id}`

- 约束规则：

- **POST** `/md/constraint-rules`
- **GET** `/md/constraint-rules?scopeType=0`
- **PATCH** `/md/constraint-rules/{id}`

---

## 4. 日历（按天/班次，容量=辆/班）

### 4.1 批量设置工作日/休息日

**POST** `/calendar/days:batch-set`

```
{ "resourceType": 1, "resourceId": 2401, "fromDate": "2026-01-22", "toDate": "2026-02-05", "isWorkday": 1 }
```

### 4.2 查询日历（日）

**GET** `/calendar/days?resourceType=1&resourceId=2401&fromDate=2026-01-22&toDate=2026-02-05`

### 4.3 设置某天班次容量

**POST** `/calendar/shifts:set`

```
{
  "resourceType": 1,
  "resourceId": 2401,
  "bizDate": "2026-01-22",
  "shifts": [
    { "shiftCode": "D1", "startTime": "08:00:00", "endTime": "20:00:00", "capacityQty": 240, "status": 1 },
    { "shiftCode": "N1", "startTime": "20:00:00", "endTime": "08:00:00", "capacityQty": 200, "status": 1 }
  ]
}
```

### 4.4 查询班次

**GET** `/calendar/shifts?resourceType=1&resourceId=2401&fromDate=2026-01-22&toDate=2026-02-05`

### 4.5 维护窗口

- **POST** `/calendar/maintenance-windows`
- **GET** `/calendar/maintenance-windows?resourceType=3&resourceId=6101&fromTime=...&toTime=...`
- **PATCH** `/calendar/maintenance-windows/{id}`
- **DELETE** `/calendar/maintenance-windows/{id}`

---

## 5. 订单与审批（前端业务核心）

### 5.1 销售订单

- **POST** `/sales-orders`
- **GET** `/sales-orders?status=0&fromDueDate=...&toDueDate=...`
- **GET** `/sales-orders/{id}`
- **POST** `/sales-orders/{id}/approve`
- **POST** `/sales-orders/{id}/to-prod`

### 5.2 生产订单（含插单/返工）

- **POST** `/prod-orders`
- **GET** `/prod-orders?status=2&orderKind=4&fromDueDate=...`
- **GET** `/prod-orders/{id}`（含 attrs）
- **PATCH** `/prod-orders/{id}`（仅草稿/待审批可改）
- **POST** `/prod-orders/{id}/attrs:set`
- **POST** `/prod-orders/{id}/submit-approve`
- **POST** `/prod-orders/{id}/approve`（管理员）
- **POST** `/prod-orders/{id}/reject`（管理员）
- **POST** `/prod-orders/{id}/cancel`

### 5.3 审批任务（工作台）

- **GET** `/approve/tasks?status=0`
- **POST** `/approve/tasks/{id}/pass`
- **POST** `/approve/tasks/{id}/reject`

---

## 6. 计划（MPS/MRP）

### 6.1 MPS

- **POST** `/plans/mps`
- **GET** `/plans/mps`
- **GET** `/plans/mps/{id}`
- **POST** `/plans/mps/{id}/submit-approve`
- **POST** `/plans/mps/{id}/approve`
- **POST** `/plans/mps/{id}/close`

### 6.2 MRP

- **POST** `/plans/mrp:run`（输入 mpsId）
- **GET** `/plans/mrp?mpsId=...`
- **GET** `/plans/mrp/{id}`

---

## 7. 排产（前端核心：方案/甘特图/发布）

### 7.1 创建排产任务

**POST** `/schedules/jobs`  
建议 Header：`Idempotency-Key`

```
{
  "horizonStart": "2026-01-22",
  "horizonEnd": "2026-02-05",
  "prodOrderIds": [3001,3002],
  "processTypes": [1,2,3,4],
  "lineScope": [
    { "processType": 1, "lineIds": [2101] },
    { "processType": 2, "lineIds": [2201,2202] },
    { "processType": 3, "lineIds": [2301] },
    { "processType": 4, "lineIds": [2401] }
  ],
  "objective": { "dueDateWeight": 0.5, "setupWeight": 0.3, "utilizationWeight": 0.2 },
  "constraints": { "enableMoldChange": true, "enableColorSwitch": true, "enableMaterialKitCheck": true, "respectMaintenanceWindow": true }
}
```

### 7.2 运行排产（异步）

**POST** `/schedules/jobs/{jobId}/run`

### 7.3 查询排产任务状态（轮询）

**GET** `/schedules/jobs/{jobId}`

- 前端轮询直到 `status in [2,3,4]`

### 7.4 方案列表

**GET** `/schedules/plans?jobId=9001`

### 7.5 方案明细（班次桶）

**GET** `/schedules/plans/{planId}?processType=4&fromDate=...&toDate=...&lineId=...`

### 7.6 甘特图数据（react-gantt-timeline）

**GET** `/schedules/plans/{planId}/gantt?processType=4&fromDate=...&toDate=...`

**返回 data 结构约定**：

```
{
  "timeline": { "start": "2026-01-22T08:00:00+08:00", "end": "2026-02-05T08:00:00+08:00" },
  "rows": [
    {
      "resourceId": 2401,
      "resourceName": "总装线1",
      "items": [
        {
          "id": 70001,
          "start": "2026-01-22T08:00:00+08:00",
          "end": "2026-01-22T20:00:00+08:00",
          "label": "MO20260122001 x60 (D1)",
          "meta": { "bucketId": 70001, "prodOrderId": 3001, "qty": 60, "seqNo": 1, "shiftCode": "D1", "bizDate": "2026-01-22", "processType": 4 }
        }
      ]
    }
  ]
}
```

### 7.7 冲突列表（前端弹窗/侧栏）

**GET** `/schedules/plans/{planId}/conflicts`

### 7.8 手动调整（拖拽/改顺序）

**POST** `/schedules/plans/{planId}/adjust`

```
{
  "changes": [
    { "bucketId": 70001, "toBizDate": "2026-01-23", "toShiftCode": "D1", "toSeqNo": 2, "toLineId": 2401 }
  ],
  "recheck": true
}
```

返回应含：最新 KPI + conflicts（若有）

### 7.9 发布方案生成工单

**POST** `/schedules/plans/{planId}/publish`

```
{ "remark": "发布A方案" }
```

### 7.10 作废方案（管理员）

**POST** `/schedules/plans/{planId}/void`

```
{ "reason": "改用B方案" }
```

---

## 8. 工单执行（前端生产看板）

### 8.1 工单列表（按工艺/日期/班次/产线过滤）

**GET** `/work-orders?processType=4&lineId=2401&bizDate=2026-01-22&shiftCode=D1&status=1`

### 8.2 工单详情

**GET** `/work-orders/{id}`

### 8.3 工单流转

- **POST** `/work-orders/{id}/release`
- **POST** `/work-orders/{id}/start`
- **POST** `/work-orders/{id}/pause`
- **POST** `/work-orders/{id}/resume`
- **POST** `/work-orders/{id}/complete`
- **POST** `/work-orders/{id}/void`（管理员）

### 8.4 报工

**POST** `/work-orders/{id}/report`

```
{ "reportTime": "2026-01-22T10:12:00+08:00", "stationId": 5101, "qtyGood": 10, "qtyBad": 1, "detailJson": { "temp": 40.2 } }
```

---

## 9. 异常管理

### 9.1 上报异常

**POST** `/exceptions`

```
{ "woId": 80001, "type": "EQUIPMENT_FAIL", "level": 2, "desc": "焊装机器人故障", "payload": { "equipCode": "RB-01" } }
```

### 9.2 异常列表/详情

- **GET** `/exceptions?status=0&level=2&type=EQUIPMENT_FAIL&fromTime=...&toTime=...`
- **GET** `/exceptions/{id}`

### 9.3 异常处理

- **POST** `/exceptions/{id}/accept`
- **POST** `/exceptions/{id}/close`

```
{ "comment": "已恢复" }
```

---

## 10. VIN 与追溯

### 10.1 生成VIN（按订单批量）

**POST** `/vins:batch-create`

```
{ "prodOrderId": 3001, "qty": 60, "ruleCode": "VIN-A7L-V1" }
```

### 10.2 VIN查询

**GET** `/vins?keyword=LFV&status=1&pageNo=1&pageSize=20`

### 10.3 VIN详情

**GET** `/vins/{vin}`

### 10.4 VIN事件追溯

**GET** `/vins/{vin}/events?fromTime=...&toTime=...`

### 10.5 绑定组件（追溯）

**POST** `/vins/{vin}/components:bind`

```
{ "partCode": "P001", "serialNo": "SN123", "bindTime": "2026-01-22T11:00:00+08:00", "payload": {} }
```

---

## 11. 报表与可视化（ECharts）

### 11.1 KPI总览

**GET** `/reports/kpi/overview?fromDate=2026-01-22&toDate=2026-02-05&processType=4`

### 11.2 产线负荷

**GET** `/reports/kpi/line-load?fromDate=...&toDate=...&processType=4`

### 11.3 换型分析

**GET** `/reports/kpi/setup?planId=9101&processType=3`

### 11.4 瓶颈分析

**GET** `/reports/bottleneck?planId=9101`

---

# 前端页面-接口对照（建议）

- 登录页：`POST /auth/login`、`GET /auth/me`
- 字典缓存：`GET /dict/items`
- 主数据：`/md/*`
- 日历配置：`/calendar/*`
- 订单中心：`/sales-orders`、`/prod-orders`、`/approve/tasks`
- 排产中心：`/schedules/*`（甘特图/调整/发布）
- 执行看板：`/work-orders/*`、`/exceptions/*`
- 追溯查询：`/vins/*`
- 数据驾驶舱：`/reports/*`